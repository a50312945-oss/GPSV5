<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>GPS 行程記錄（地圖版 v12 直上可用）</title>
  <meta name="theme-color" content="#0b1320"/>
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    :root{ --bg:#0b1320; --card:#0f1a2e; --muted:#94a3b8; --text:#e6edf6;
           --accent:#60a5fa; --ok:#34d399; --warn:#fbbf24; --bad:#ef4444; --border:#1f2a44; }
    *{box-sizing:border-box}
    html, body { height:100% }
    body{ margin:0; background:linear-gradient(180deg,#0b1320 0%, #0f172a 100%); color:var(--text);
          font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "Microsoft JhengHei", Arial, "Helvetica Neue", sans-serif; }
    header{ position:sticky; top:0; z-index:50; backdrop-filter:blur(8px);
      background:rgba(11,19,32,.85); border-bottom:1px solid var(--border); padding:10px 14px }
    h1{ font-size:18px; margin:0 }
    .wrap{ padding:12px; max-width:900px; margin:0 auto }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px; box-shadow:0 8px 24px rgba(0,0,0,.25); margin-bottom:12px }
    .btns{ display:grid; grid-template-columns:1fr 1fr; gap:8px }
    button{ padding:14px 16px; border-radius:12px; border:1px solid #25406f; background:#132544; color:var(--text); font-size:17px }
    button.primary{ background:var(--accent); border-color:transparent; color:#051427; font-weight:700 }
    button.ok{ background:var(--ok); border-color:transparent; color:#05251c; font-weight:700 }
    button.warn{ background:var(--warn); border-color:transparent; color:#221904; font-weight:700 }
    button.bad{ background:var(--bad); border-color:transparent; color:#2b0b0b; font-weight:700 }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:8px }
    @media (max-width: 760px){ .grid{ grid-template-columns:1fr 1fr } }
    .kv{ background:#0c1426; border:1px solid var(--border); border-radius:12px; padding:10px }
    .k{ font-size:12px; color:var(--muted) }
    .v{ font-size:16px; margin-top:4px; word-break:break-all }
    #map{ height:60vh; min-height:340px; border-radius:14px; border:1px solid #20355e; overflow:hidden }
    table{ width:100%; border-collapse:collapse; font-size:14px }
    th,td{ padding:10px; border-bottom:1px dashed #20355e; text-align:left }
    th{ position:sticky; top:0; background:#0c1426; z-index:1 }
    .muted{ color:var(--muted); font-size:12px }
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px }
    input{ width:100%; padding:12px; border-radius:10px; border:1px solid #2a3b61;
           background:#0c1426; color:var(--text); font-size:16px }
    .link{ color:#93c5fd; text-decoration:underline; cursor:pointer }
    .fabbar{ position:fixed; left:0; right:0; bottom:0; z-index:60;
      background:rgba(11,19,32,.92); backdrop-filter:blur(8px);
      border-top:1px solid #1f2a44; padding:8px 10px calc(8px + env(safe-area-inset-bottom)); }
    .fabrow{ display:flex; gap:8px; overflow-x:auto; -webkit-overflow-scrolling:touch; }
    .fabrow button{ flex:1 0 auto; white-space:nowrap; padding:12px 14px; border-radius:12px; }
    body{ padding-bottom:80px }
    .toast{position:fixed;left:50%;bottom:90px;transform:translateX(-50%);
      background:rgba(0,0,0,.85);color:#fff;padding:8px 12px;border-radius:10px;font-size:14px;z-index:9999;opacity:0;transition:opacity .2s}
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <header>
    <h1>GPS 行程記錄（v12）<span class="muted">起訖必填｜名稱=A到B</span></h1>
  </header>

  <div class="wrap">
    <div class="card" style="margin-top:0">
      <div class="grid">
        <div><label>車牌</label><input id="plate" placeholder="例：ABC-1234"></div>
        <div><label>駕駛人</label><input id="driver" placeholder="例：王小明"></div>
        <div><label>姓名</label><input id="personName" placeholder="例：黃士源"></div>
        <div><label>開始里程數（km）</label><input id="startOdo" type="number" inputmode="decimal" step="0.1" placeholder="例：12035.6"></div>
      </div>
    </div>

    <div class="card">
      <div class="btns">
        <button id="startBtn" class="primary" onclick="handleStart()">開始定位</button>
        <button id="stopBtn" onclick="handleStop()">停止定位</button>
        <button id="tripStartBtn" class="ok" onclick="handleTripStart()">開始行程（必填名）</button>
        <button id="tripStopBtn" class="warn" onclick="handleTripStop()">停止行程（必填名＋結算）</button>
        <button id="exportXlsxBtn" class="ok" onclick="exportXLSX()">匯出 Excel</button>
        <button id="resetBtn" class="bad" onclick="resetAll()">重置全部</button>
      </div>
      <div style="height:10px"></div>
      <div id="map"></div>
      <div style="height:10px"></div>
      <div class="grid">
        <div class="kv"><div class="k">緯度</div><div id="lat" class="v">—</div></div>
        <div class="kv"><div class="k">經度</div><div id="lng" class="v">—</div></div>
        <div class="kv"><div class="k">精確度 (m)</div><div id="acc" class="v">—</div></div>
        <div class="kv"><div class="k">速度 (km/h)</div><div id="spd" class="v">—</div></div>
        <div class="kv"><div class="k">目前行程里程 (km)</div><div id="tripDist" class="v">0.000</div></div>
        <div class="kv"><div class="k">目前里程表 (km)</div><div id="currentOdo" class="v">—</div></div>
        <div class="kv"><div class="k">更新時間</div><div id="ts" class="v">—</div></div>
        <div class="kv"><div class="k">狀態</div><div id="status" class="v">尚未開始</div></div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <div>行程列表 <span id="tripCount" class="muted">(0)</span></div>
        <div class="muted">欄位：名稱、開始、停止、單趟里程、單次行程加總（=開始里程數+單趟里程）</div>
      </div>
      <table>
        <thead><tr><th>#</th><th>名稱</th><th>開始</th><th>停止</th><th>單趟里程(km)</th><th>單次行程加總(km)</th><th>操作</th></tr></thead>
        <tbody id="tripBody"></tbody>
      </table>
    </div>
  </div>

  <div class="fabbar">
    <div class="fabrow">
      <button class="primary" onclick="handleStart()">開始定位</button>
      <button onclick="handleStop()">停止定位</button>
      <button class="ok" onclick="handleTripStart()">開始行程</button>
      <button class="warn" onclick="handleTripStop()">停止行程</button>
      <button class="ok" onclick="exportXLSX()">匯出Excel</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    const $ = (id)=>document.getElementById(id);
    const set = (id, v)=>{ const el=$(id); if(el) el.textContent=v; };
    function toast(msg){ const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 900); }
    function fmt(n, d=6){ return (n==null || Number.isNaN(n)) ? "—" : Number(n).toFixed(d) }
    function kph(mps){ return (mps==null || Number.isNaN(mps)) ? null : mps*3.6 }
    function tsFmt(d){ const p=(x)=>String(x).padStart(2,'0'); return d.getFullYear()+"-"+p(d.getMonth()+1)+"-"+p(d.getDate())+" "+p(d.getHours())+":"+p(d.getMinutes())+":"+p(d.getSeconds()) }
    function hav(a,b){
      const R=6371000, toRad=x=>x*Math.PI/180;
      const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
      const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
      const aa=s1*s1 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
      return 2*R*Math.atan2(Math.sqrt(aa), Math.sqrt(1-aa));
    }
    function tripTitle(a,b){ a=(a||'').trim(); b=(b||'').trim(); return (a&&b) ? `${a}到${b}` : (a||b||''); }
    function requireNonEmpty(promptText, defVal){
      while(true){
        let v = window.prompt(promptText, defVal) || "";
        if(v.trim()!=="") return v.trim();
        if(!window.confirm("名稱不能空白。是否再次輸入？")) return null;
      }
    }
    function downloadText(name, text, type="text/plain"){
      const blob = new Blob([text], {type:type+";charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = name;
      document.body.appendChild(a); a.click();
      URL.revokeObjectURL(url); a.remove();
    }

    // State
    let watchId=null, last=null, tripActive=false, tripDist=0, tripStartTime=null, tripStartName="";
    let trips=[];

    // Map
    let map, marker, circle, track;
    function initMap(){
      try{
        map = L.map('map', { zoomControl: true, tap: true });
        const initial = [23.6978, 120.9605];
        map.setView(initial, 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19, attribution: '&copy; OpenStreetMap'
        }).addTo(map);
        marker = L.marker(initial).addTo(map);
        circle = L.circle(initial, { radius: 1, weight:1, fillOpacity:.08 }).addTo(map);
        track = L.polyline([], { weight:4 }).addTo(map);
      }catch(e){
        console.warn('Map init failed (可先不理地圖)：', e);
      }
    }
    initMap();

    function currentOdo(){
      const startOdoStr = ($('startOdo').value||"").trim();
      const startOdo = startOdoStr===""? 0 : parseFloat(startOdoStr);
      const km = tripDist/1000;
      return (isNaN(startOdo)?0:startOdo) + km;
    }
    function renderCurrentOdo(){ set('currentOdo', fmt(currentOdo(),3)); }

    function updateUI(pos){
      const c = pos.coords, now = new Date(pos.timestamp||Date.now());
      set('lat', fmt(c.latitude,6));
      set('lng', fmt(c.longitude,6));
      set('acc', fmt(c.accuracy,1));
      const spd = kph(c.speed); set('spd', (spd==null? '—' : fmt(spd,1)));
      set('ts', tsFmt(now));

      const cur = {lat:c.latitude, lng:c.longitude};
      if(map && marker && circle && track){
        if(!map._hasFix){ map._hasFix = true; map.setView([cur.lat,cur.lng], 18); }
        marker.setLatLng(cur);
        circle.setLatLng(cur);
        circle.setRadius(c.accuracy || 1);
        const latlngs = track.getLatLngs ? track.getLatLngs() : []; latlngs.push(cur); track.setLatLngs && track.setLatLngs(latlngs);
      }

      if(last){
        const d = hav(last, cur);
        const isJump = (d>150 && (c.accuracy||999)>50);
        if(!isJump){ if(tripActive) tripDist += d; }
      }
      last = cur;
      set('tripDist', fmt(tripDist/1000,3));
      renderCurrentOdo();
    }

    function startOncePrompt(){
      if(!('geolocation' in navigator)){ set('status','此裝置不支援定位'); toast('此裝置不支援定位'); return; }
      navigator.geolocation.getCurrentPosition(
        (pos)=>{ set('status','已取得權限'); updateUI(pos); },
        (err)=>{ set('status','定位錯誤 code='+err.code); toast('定位錯誤 code='+err.code); },
        {enableHighAccuracy:true, maximumAge:0, timeout:12000}
      );
    }

    function startWatch(){
      if(!('geolocation' in navigator)){ set('status','此裝置不支援定位'); toast('不支援定位'); return; }
      set('status','嘗試取得定位...');
      try{
        watchId = navigator.geolocation.watchPosition(
          (pos)=>{ set('status','定位中'); updateUI(pos); },
          (err)=>{
            const m={1:"拒絕權限",2:"位置不可用",3:"逾時"};
            set('status', '錯誤：'+(m[err.code]||'未知錯誤')); toast('錯誤：'+(m[err.code]||'未知'));
          },
          {enableHighAccuracy:true, maximumAge:1000, timeout:15000}
        );
      }catch(e){ console.error(e); toast('watchPosition 失敗'); }
    }
    function stopWatch(){ if(watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; set('status','已停止定位'); toast('已停止定位'); } }

    // Trips
    function defaultTripName(prefix){
      const t = $('ts').textContent;
      return (prefix||"行程") + "@" + (t ? t.replace(" ","T") : new Date().toISOString());
    }
    function handleTripStart(){ toast('開始行程點擊'); tripStart(); }
    function handleTripStop(){ toast('停止行程點擊'); tripStop(); }
    function handleStart(){ toast('開始定位點擊'); startOncePrompt(); startWatch(); }
    function handleStop(){ toast('停止定位點擊'); stopWatch(); }

    function tripStart(){
      if(tripActive){ alert("行程已在進行中"); return; }
      const name = requireNonEmpty("請輸入『開始行程』名稱（起點，必填）", defaultTripName("起點"));
      if(name===null) return;
      tripStartName = name;
      tripActive = true;
      tripDist = 0;
      tripStartTime = $('ts').textContent || new Date().toISOString();
      set('tripDist', '0.000'); renderCurrentOdo();
      set('status', '開始行程：'+tripStartName);
    }
    function tripStop(){
      if(!tripActive){ alert("尚未開始行程"); return; }
      const endName = requireNonEmpty("請輸入『結束行程』名稱（終點，必填）", defaultTripName("終點"));
      if(endName===null) return;
      const end = $('ts').textContent || new Date().toISOString();
      const km = tripDist/1000;
      const startOdoStr = ($('startOdo').value||"").trim();
      const startOdo = startOdoStr===""? 0 : parseFloat(startOdoStr);
      const odoTotal = (isNaN(startOdo)?0:startOdo) + km;
      trips.push({ startName: tripStartName, endName, start: tripStartTime, end, km, odoTotal, title: tripTitle(tripStartName, endName) });
      renderTrips();
      // reset
      tripActive=false; tripDist=0; tripStartTime=null; tripStartName="";
      set('tripDist','0.000'); renderCurrentOdo();
      set('status','行程已結算');
    }
    function renameTrip(which, idx){
      const t = trips[idx];
      const label = which==='start' ? "開始名稱" : "結束名稱";
      const cur = which==='start' ? t.startName : t.endName;
      const v = requireNonEmpty(`重新命名 ${label}（必填）`, cur||"");
      if(v===null) return;
      if(which==='start'){ t.startName=v; } else { t.endName=v; }
      t.title = tripTitle(t.startName, t.endName);
      renderTrips();
    }
    function renderTrips(){
      const tb = $('tripBody'); tb.innerHTML="";
      trips.forEach((t,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td>
          <td>${t.title||tripTitle(t.startName,t.endName)}</td>
          <td>${t.start}</td><td>${t.end}</td>
          <td>${t.km.toFixed(3)}</td>
          <td>${t.odoTotal.toFixed(3)}</td>
          <td><span class="link" onclick="renameTrip('start',${i})">改起點</span>｜<span class="link" onclick="renameTrip('end',${i})">改終點</span></td>`;
        tb.appendChild(tr);
      });
      $('tripCount').textContent = "("+trips.length+")";
    }

    // Excel (AOA + 固定表頭 + A到B 第一欄)
    function exportXLSX(){
      const driver = $('driver').value||'';
      const plate = $('plate').value||'';
      const person = $('personName').value||'';
      const startOdoStr = ($('startOdo').value||'').trim();
      const baseStartOdo = startOdoStr===''? 0 : parseFloat(startOdoStr);
      const headers = ['行程名稱（A到B）','啟程地點','停止行程地點','起程時間','到達時間','啟程公里數','到達公里數','小計哩程數','駕駛人','車牌','姓名'];
      const rows = trips.map(t=>{
        const tripKm = Number(t.km||0);
        const startKm = isNaN(baseStartOdo)? 0 : baseStartOdo;
        const endKm = startKm + tripKm;
        const title = (t.title && String(t.title).trim())
          || ((t.startName||'').trim() && (t.endName||'').trim() ? `${(t.startName||'').trim()}到${(t.endName||'').trim()}`
             : ((t.startName||'').trim() || (t.endName||'').trim()));
        return [title||'', t.startName||'', t.endName||'', t.start||'', t.end||'',
                Number(startKm.toFixed(3)), Number(endKm.toFixed(3)), Number(tripKm.toFixed(3)),
                driver, plate, person];
      });
      const data = [headers, ...rows];
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(data);
      ws['!freeze'] = { xSplit: 0, ySplit: 1, topLeftCell: 'A2', activePane: 'bottomLeft', state: 'frozen' };
      ws['!cols'] = [{wch:18},{wch:16},{wch:18},{wch:20},{wch:20},{wch:14},{wch:14},{wch:14},{wch:12},{wch:12},{wch:12}];
      XLSX.utils.book_append_sheet(wb, ws, '里程');
      XLSX.writeFile(wb, '行程里程匯出_v12_首欄A到B.xlsx');
      toast('已匯出 Excel');
    }

    // Persistence
    const metaKeys = { plate:'plate', driver:'driver', personName:'personName', startOdo:'startOdo' };
    function saveMeta(){
      localStorage.setItem(metaKeys.plate, $('plate').value||"");
      localStorage.setItem(metaKeys.driver, $('driver').value||"");
      localStorage.setItem(metaKeys.personName, $('personName').value||"");
      localStorage.setItem(metaKeys.startOdo, $('startOdo').value||"");
      renderCurrentOdo();
    }
    function loadMeta(){
      $('plate').value = localStorage.getItem(metaKeys.plate)||"";
      $('driver').value = localStorage.getItem(metaKeys.driver)||"";
      $('personName').value = localStorage.getItem(metaKeys.personName)||"";
      $('startOdo').value = localStorage.getItem(metaKeys.startOdo)||"";
      renderCurrentOdo();
    }
    function resetAll(){
      trips=[]; renderTrips();
      tripActive=false; tripDist=0; tripStartTime=null; tripStartName="";
      set('tripDist','0.000'); renderCurrentOdo();
      last=null;
      toast('已重置');
    }

    // also bind touch/pointer fallback to ensure click
    ['startBtn','stopBtn','tripStartBtn','tripStopBtn','exportXlsxBtn','resetBtn'].forEach(id=>{
      const el = $(id); if(!el) return;
      ['touchstart','pointerdown'].forEach(ev=> el.addEventListener(ev, (e)=>{ /* no-op: ensure focus */ }, {passive:true}));
    });

    window.addEventListener('load', ()=>{
      loadMeta();
      ['plate','driver','personName','startOdo'].forEach(id=> $(id).addEventListener('input', saveMeta));
    });
  </script>
</body>
</html>
