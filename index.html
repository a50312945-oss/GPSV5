<!DOCTYPE html>
<html class="dark" lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="description" content="GPS æ²¹å–®è¼”åŠ©ç³»çµ± - å°ˆç‚ºé•·é€”è¡Œç¨‹è¨­è¨ˆï¼Œå…·å‚™å¤šé‡é˜²è­·æ©Ÿåˆ¶ï¼Œè‡ªå‹•å‚™ä»½ï¼Œç¢ºä¿ç©©å®šè¨˜éŒ„"/>
  <meta name="author" content="GPS Fuel Report Assistant"/>
  <meta name="version" content="1.0.0"/>
  
  <title>GPS æ²¹å–®è¼”åŠ©ç³»çµ± v1.0</title>
  
  <!-- PWA Icons -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0icGluR3JhZGllbnQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMCUiIHkyPSIxMDAlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6IzEzZWM1YjtzdG9wLW9wYWNpdHk6MSIgLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojMGJhMzQ0O3N0b3Atb3BhY2l0eToxIiAvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICA8L2RlZnM+CiAgPHJlY3Qgd2lkdGg9IjUxMiIgaGVpZ2h0PSI1MTIiIHJ4PSIxMTUiIGZpbGw9IiMxMDIyMTYiLz4KICA8cGF0aCBkPSJNIDI1NiA5NiBDIDE5Ny43IDk2IDE1MCAxNDMuNyAxNTAgMjAyIEMgMTUwIDI4MyAyNTYgNDE2IDI1NiA0MTYgUyAzNjIgMjgzIDM2MiAyMDIgQyAzNjIgMTQzLjcgMzE0LjMgOTYgMjU2IDk2IFoiIGZpbGw9InVybCgjcGluR3JhZGllbnQpIiBzdHJva2U9IiMwYTdhMzMiIHN0cm9rZS13aWR0aD0iNCIvPgogIDxwYXRoIGQ9Ik0gMjMyIDE4MCBMIDIzMiAyNjAgTCAyOTUgMjIwIFoiIGZpbGw9IiMxMDIyMTYiIG9wYWNpdHk9IjAuOSIvPgo8L3N2Zz4="/>
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0icGluR3JhZGllbnQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMCUiIHkyPSIxMDAlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6IzEzZWM1YjtzdG9wLW9wYWNpdHk6MSIgLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojMGJhMzQ0O3N0b3Atb3BhY2l0eToxIiAvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICA8L2RlZnM+CiAgPHJlY3Qgd2lkdGg9IjUxMiIgaGVpZ2h0PSI1MTIiIHJ4PSIxMTUiIGZpbGw9IiMxMDIyMTYiLz4KICA8cGF0aCBkPSJNIDI1NiA5NiBDIDE5Ny43IDk2IDE1MCAxNDMuNyAxNTAgMjAyIEMgMTUwIDI4MyAyNTYgNDE2IDI1NiA0MTYgUyAzNjIgMjgzIDM2MiAyMDIgQyAzNjIgMTQzLjcgMzE0LjMgOTYgMjU2IDk2IFoiIGZpbGw9InVybCgjcGluR3JhZGllbnQpIiBzdHJva2U9IiMwYTdhMzMiIHN0cm9rZS13aWR0aD0iNCIvPgogIDxwYXRoIGQ9Ik0gMjMyIDE4MCBMIDIzMiAyNjAgTCAyOTUgMjIwIFoiIGZpbGw9IiMxMDIyMTYiIG9wYWNpdHk9IjAuOSIvPgo8L3N2Zz4="/>
  <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0icGluR3JhZGllbnQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMCUiIHkyPSIxMDAlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6IzEzZWM1YjtzdG9wLW9wYWNpdHk6MSIgLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojMGJhMzQ0O3N0b3Atb3BhY2l0eToxIiAvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICA8L2RlZnM+CiAgPHJlY3Qgd2lkdGg9IjUxMiIgaGVpZ2h0PSI1MTIiIHJ4PSIxMTUiIGZpbGw9IiMxMDIyMTYiLz4KICA8cGF0aCBkPSJNIDI1NiA5NiBDIDE5Ny43IDk2IDE1MCAxNDMuNyAxNTAgMjAyIEMgMTUwIDI4MyAyNTYgNDE2IDI1NiA0MTYgUyAzNjIgMjgzIDM2MiAyMDIgQyAzNjIgMTQzLjcgMzE0LjMgOTYgMjU2IDk2IFoiIGZpbGw9InVybCgjcGluR3JhZGllbnQpIiBzdHJva2U9IiMwYTdhMzMiIHN0cm9rZS13aWR0aD0iNCIvPgogIDxwYXRoIGQ9Ik0gMjMyIDE4MCBMIDIzMiAyNjAgTCAyOTUgMjIwIFoiIGZpbGw9IiMxMDIyMTYiIG9wYWNpdHk9IjAuOSIvPgo8L3N2Zz4="/>
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkdQU+ayueWWrui8lOWKqeezu+e1sSIsCiAgInNob3J0X25hbWUiOiAiR1BT5rK55ZauIiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMxMDIyMTYiLAogICJ0aGVtZV9jb2xvciI6ICIjMTNlYzViIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpSUhacFpYZENiM2c5SWpBZ01DQTFNVElnTlRFeUlqNEtJQ0E4WkdWbWN6NEtJQ0FnSUR4c2FXNWxZWEpIY21Ga2FXVnVkQ0JwWkQwaWNHbHVSM0poWkdsbGJuUWlJSGd4UFNJd0pTSWdlVEU5SWpBbElpQjRNajBpTUNVaUlIa3lQU0l4TURBbElqNEtJQ0FnSUNBZ1BITjBiM0FnYjJabWMyVjBQU0l3SlNJZ2MzUjViR1U5SW5OMGIzQXRZMjlzYjNJNkl6RXpaV00xWWp0emRHOXdMVzl3WVdOcGRIazZNU0lnTHo0S0lDQWdJQ0FnUEhOMGIzQWdiMlptYzJWMFBTSXhNREFsSWlCemRIbHNaVDBpYzNSdmNDMWpiMnh2Y2pvak1HSmhNelEwTzNOMGIzQXRiM0JoWTJsMGVUb3hJaUF2UGdvZ0lDQWdQQzlzYVc1bFlYSkhjbUZrYVdWdWRENEtJQ0E4TDJSbFpuTStDaUFnUEhKbFkzUWdkMmxrZEdnOUlqVXhNaUlnYUdWcFoyaDBQU0kxTVRJaUlISjRQU0l4TVRVaUlHWnBiR3c5SWlNeE1ESXlNVFlpTHo0S0lDQThjR0YwYUNCa1BTSk5JREkxTmlBNU5pQkRJREU1Tnk0M0lEazJJREUxTUNBeE5ETXVOeUF4TlRBZ01qQXlJRU1nTVRVd0lESTRNeUF5TlRZZ05ERTJJREkxTmlBME1UWWdVeUF6TmpJZ01qZ3pJRE0yTWlBeU1ESWdReUF6TmpJZ01UUXpMamNnTXpFMExqTWdPVFlnTWpVMklEazJJRm9pSUdacGJHdzlJblZ5YkNnamNHbHVSM0poWkdsbGJuUXBJaUJ6ZEhKdmEyVTlJaU13WVRkaE16TWlJSE4wY205clpTMTNhV1IwYUQwaU5DSXZQZ29nSUR4d1lYUm9JR1E5SWswZ01qTXlJREU0TUNCTUlESXpNaUF5TmpBZ1RDQXlPVFVnTWpJd0lGb2lJR1pwYkd3OUlpTXhNREl5TVRZaUlHOXdZV05wZEhrOUlqQXVPU0l2UGdvOEwzTjJaejQ9IiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIgogICAgfQogIF0KfQo="/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#13ec5b",
            "background-light": "#f6f8f6",
            "background-dark": "#102216",
            "surface-dark": "#1a2e22",
          },
          fontFamily: {
            "display": ["Plus Jakarta Sans", "Noto Sans TC", "sans-serif"],
            "body": ["Noto Sans TC", "sans-serif"],
          },
          borderRadius: {
            "DEFAULT": "1rem",
            "lg": "2rem",
            "xl": "3rem",
            "full": "9999px"
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'ripple': 'ripple 2s linear infinite',
            'blink': 'blink 1s ease-in-out infinite',
          },
          keyframes: {
            ripple: {
              '0%': { transform: 'scale(1)', opacity: '0.4' },
              '100%': { transform: 'scale(1.5)', opacity: '0' },
            },
            blink: {
              '0%, 100%': { opacity: '1' },
              '50%': { opacity: '0.3' },
            }
          }
        },
      },
    }
  </script>
  <style>
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
    .map-gradient {
      background: linear-gradient(to bottom, rgba(16,34,22,0) 0%, rgba(16,34,22,0.95) 90%, rgba(16,34,22,1) 100%);
    }
    body {
      min-height: max(884px, 100dvh);
    }
    #map {
      filter: grayscale(100%) invert(85%) hue-rotate(180deg) brightness(80%) contrast(120%);
    }
    .hidden { display: none !important; }
    .tabular-nums {
      font-feature-settings: 'tnum' on, 'lnum' on;
    }
    /* æ•¸å­—å®¹å™¨ */
    .distance-display {
      display: flex;
      align-items: baseline;
      gap: 0.25rem;
      width: 100%;
      min-height: 3rem;
    }
    .distance-display .number {
      font-weight: 700;
      white-space: nowrap;
      line-height: 1;
    }
    .distance-display .unit {
      flex-shrink: 0;
      font-weight: 500;
      opacity: 0.7;
    }
    /* é˜²æ­¢è¢å¹•ä¼‘çœ  - ä½¿ç”¨ CSS å‹•ç•«æŠ€å·§ */
    @keyframes preventSleep {
      0% { opacity: 0.999; }
      100% { opacity: 1; }
    }
    .keep-awake {
      animation: preventSleep 30s infinite;
    }
    /* éš±è—çš„éŸ³é »æ’­æ”¾å™¨ */
    #silentAudio {
      position: absolute;
      left: -9999px;
      width: 1px;
      height: 1px;
    }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-neutral-900 dark:text-white font-display min-h-screen flex flex-col overflow-x-hidden relative selection:bg-primary selection:text-black keep-awake">
  
  <!-- éœéŸ³éŸ³é »ï¼ˆé˜²æ­¢ iOS ä¼‘çœ ï¼‰ -->
  <audio id="silentAudio" loop>
    <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=" type="audio/wav">
  </audio>
  
  <!-- é ‚éƒ¨å°èˆªåˆ— -->
  <div class="flex items-center p-4 pt-6 pb-2 justify-between z-20 relative">
    <div class="flex items-center gap-3">
      <button onclick="toggleMenu()" class="flex items-center justify-center w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 transition-colors backdrop-blur-md">
        <span class="material-symbols-outlined text-white text-[20px]">menu</span>
      </button>
      <h2 class="text-neutral-900 dark:text-white text-lg font-bold leading-tight tracking-tight">GPSæ²¹å–®è¼”åŠ©ç³»çµ±</h2>
    </div>
    <div class="flex items-center gap-2">
      <!-- é›»æ± ç‹€æ…‹ -->
      <div id="batteryStatus" class="hidden items-center gap-1 bg-surface-dark/50 dark:bg-black/30 px-3 py-1.5 rounded-full border border-white/5 backdrop-blur-sm">
        <span id="batteryIcon" class="material-symbols-outlined text-primary text-[16px]">battery_full</span>
        <span id="batteryText" class="text-xs font-bold text-primary tracking-wider">100%</span>
      </div>
      
      <div id="gpsStatus" class="flex items-center gap-1 bg-surface-dark/50 dark:bg-black/30 px-3 py-1.5 rounded-full border border-white/5 backdrop-blur-sm">
        <span class="material-symbols-outlined text-neutral-500 text-[16px]">signal_cellular_alt</span>
        <span class="text-xs font-bold text-neutral-500 tracking-wider">å¾…æ©Ÿ</span>
      </div>
      
      <div id="connectionStatus" class="flex items-center gap-1 bg-surface-dark/50 dark:bg-black/30 px-3 py-1.5 rounded-full border border-white/5 backdrop-blur-sm">
        <span id="connectionIcon" class="material-symbols-outlined text-primary text-[16px]">check_circle</span>
        <span id="connectionText" class="text-xs font-bold text-primary tracking-wider">æ­£å¸¸</span>
      </div>
      
      <button onclick="toggleSettings()" class="flex items-center justify-center w-10 h-10 rounded-full bg-transparent hover:bg-white/10 text-neutral-900 dark:text-white transition-colors">
        <span class="material-symbols-outlined text-[24px]">settings</span>
      </button>
    </div>
  </div>

  <!-- å¤šé‡é˜²è­·ç‹€æ…‹æç¤º -->
  <div id="protectionBanner" class="hidden mx-4 mb-2 p-3 bg-blue-900/30 border border-blue-600/50 rounded-lg">
    <div class="flex items-center gap-3">
      <span class="material-symbols-outlined text-blue-400 text-[24px]">shield</span>
      <div class="flex-1">
        <p class="text-blue-200 text-sm font-semibold">å¤šé‡é˜²è­·å·²å•Ÿå‹•</p>
        <div class="text-blue-300/80 text-xs mt-1 space-y-0.5">
          <div id="protection-wakeLock" class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-neutral-500"></span>
            <span>Wake Lock: æª¢æŸ¥ä¸­...</span>
          </div>
          <div id="protection-audio" class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-neutral-500"></span>
            <span>éŸ³é »ä¿æ´»: æª¢æŸ¥ä¸­...</span>
          </div>
          <div id="protection-localStorage" class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-neutral-500"></span>
            <span>è‡ªå‹•å„²å­˜: æª¢æŸ¥ä¸­...</span>
          </div>
        </div>
      </div>
      <button onclick="toggleProtectionBanner()" class="text-blue-200 hover:text-white">
        <span class="material-symbols-outlined text-[20px]">expand_less</span>
      </button>
    </div>
  </div>

  <!-- è­¦å‘Šæ©«å¹… -->
  <div id="warningBanner" class="hidden mx-4 mb-2 p-3 bg-yellow-900/30 border border-yellow-600/50 rounded-lg flex items-center gap-3">
    <span class="material-symbols-outlined text-yellow-400 text-[24px] animate-pulse">warning</span>
    <div class="flex-1">
      <p class="text-yellow-200 text-sm font-semibold">GPS è¨Šè™Ÿä¸­æ–·</p>
      <p class="text-yellow-300/80 text-xs">è³‡æ–™å·²å‚™ä»½ï¼Œæ¢å¾©è¨Šè™Ÿå¾Œæœƒç¹¼çºŒè¿½è¹¤</p>
    </div>
    <button onclick="dismissWarning()" class="text-yellow-200 hover:text-white">
      <span class="material-symbols-outlined text-[20px]">close</span>
    </button>
  </div>

  <!-- å´é‚Šé¸å–® -->
  <div id="sideMenu" class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm" onclick="toggleMenu()">
    <div class="w-80 h-full bg-surface-dark p-6 overflow-y-auto" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-bold text-white">é¸å–®</h3>
        <button onclick="toggleMenu()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10">
          <span class="material-symbols-outlined text-white">close</span>
        </button>
      </div>
      
      <!-- é˜²è­·ç³»çµ±ç‹€æ…‹ -->
      <div class="mb-6 p-4 bg-background-dark rounded-lg border border-white/10">
        <h4 class="text-sm font-bold text-neutral-400 mb-3 flex items-center gap-2">
          <span class="material-symbols-outlined text-[18px]">security</span>
          é˜²è­·ç³»çµ±
        </h4>
        <div class="space-y-2 text-xs">
          <div id="status-wakeLock" class="flex justify-between items-center">
            <span class="text-neutral-400">Wake Lockï¼š</span>
            <span class="text-white font-semibold">æª¢æŸ¥ä¸­</span>
          </div>
          <div id="status-audio" class="flex justify-between items-center">
            <span class="text-neutral-400">éŸ³é »ä¿æ´»ï¼š</span>
            <span class="text-white font-semibold">æª¢æŸ¥ä¸­</span>
          </div>
          <div id="status-autoSave" class="flex justify-between items-center">
            <span class="text-neutral-400">è‡ªå‹•å„²å­˜ï¼š</span>
            <span class="text-white font-semibold">æ¯ 10 ç§’</span>
          </div>
          <div id="status-battery" class="flex justify-between items-center">
            <span class="text-neutral-400">é›»æ± é›»é‡ï¼š</span>
            <span class="text-white font-semibold">â€”</span>
          </div>
        </div>
      </div>
      
      <!-- ç³»çµ±ç‹€æ…‹ -->
      <div class="mb-6 p-4 bg-background-dark rounded-lg border border-white/10">
        <h4 class="text-sm font-bold text-neutral-400 mb-3">é‹è¡Œçµ±è¨ˆ</h4>
        <div class="space-y-2 text-xs">
          <div class="flex justify-between">
            <span class="text-neutral-400">å®šä½é»æ•¸ï¼š</span>
            <span id="pointCount" class="text-white font-semibold">0</span>
          </div>
          <div class="flex justify-between">
            <span class="text-neutral-400">æœ€å¾Œæ›´æ–°ï¼š</span>
            <span id="lastUpdateTime" class="text-white font-semibold">â€”</span>
          </div>
          <div class="flex justify-between">
            <span class="text-neutral-400">GPS é‡é€£æ¬¡æ•¸ï¼š</span>
            <span id="reconnectCount" class="text-white font-semibold">0</span>
          </div>
          <div class="flex justify-between">
            <span class="text-neutral-400">èƒŒæ™¯å–šé†’ï¼š</span>
            <span id="wakeupCount" class="text-white font-semibold">0</span>
          </div>
          <div class="flex justify-between">
            <span class="text-neutral-400">è‡ªå‹•å„²å­˜ï¼š</span>
            <span id="autoSaveCount" class="text-white font-semibold">0 æ¬¡</span>
          </div>
          <div class="flex justify-between">
            <span class="text-neutral-400">é‹è¡Œæ™‚é•·ï¼š</span>
            <span id="runningTime" class="text-white font-semibold">00:00:00</span>
          </div>
        </div>
      </div>
      
      <nav class="space-y-2">
        <button onclick="showView('recording'); toggleMenu()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 text-white text-left transition-colors">
          <span class="material-symbols-outlined">play_circle</span>
          <span>é–‹å§‹è¨˜éŒ„</span>
        </button>
        <button onclick="showView('history'); toggleMenu()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 text-white text-left transition-colors">
          <span class="material-symbols-outlined">history</span>
          <span>æ­·å²è¨˜éŒ„</span>
        </button>
        <button onclick="showView('settings'); toggleMenu()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 text-white text-left transition-colors">
          <span class="material-symbols-outlined">settings</span>
          <span>è¨­å®š</span>
        </button>
        <button onclick="forceBackup()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 text-white text-left transition-colors">
          <span class="material-symbols-outlined">backup</span>
          <span>ç«‹å³å‚™ä»½</span>
        </button>
        <button onclick="exportXLSX()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 text-white text-left transition-colors">
          <span class="material-symbols-outlined">download</span>
          <span>åŒ¯å‡º Excel</span>
        </button>
      </nav>
    </div>
  </div>

  <!-- ä¸»è¦å…§å®¹å€ -->
  <div class="flex-1 flex flex-col relative w-full max-w-md mx-auto h-full">
    
    <!-- è¨˜éŒ„ç•«é¢ -->
    <div id="viewRecording" class="flex-1 flex flex-col">
      <!-- åœ°åœ– -->
      <div class="relative w-full h-[45vh] shrink-0">
        <div class="absolute inset-0 w-full h-full">
          <div id="map" class="w-full h-full opacity-80 dark:opacity-60"></div>
          <div class="absolute inset-0 map-gradient"></div>
        </div>
        
        <div class="absolute top-4 left-4 flex flex-col gap-2">
          <!-- è·¯å¾‘è³‡è¨Šå¡ç‰‡ -->
          <div id="pathInfoCard" class="hidden bg-surface-dark/90 border border-white/10 rounded-xl px-3 py-2 shadow-lg backdrop-blur-md">
            <div class="flex items-center gap-2">
              <span class="material-symbols-outlined text-primary text-[18px]">route</span>
              <div>
                <p class="text-white text-xs font-semibold">è·¯å¾‘é»æ•¸</p>
                <p id="pathPointCount" class="text-primary text-sm font-bold">0</p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="absolute bottom-4 left-0 right-0 px-4 flex justify-center">
          <div class="flex gap-3 flex-wrap justify-center">
            <div id="trackingBadge" class="hidden flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-full bg-surface-dark border border-white/10 pl-3 pr-4 shadow-lg backdrop-blur-md">
              <span class="material-symbols-outlined text-primary text-[18px]">my_location</span>
              <p class="text-white text-xs font-bold uppercase tracking-wider">å¤šé‡é˜²è­·è¿½è¹¤ä¸­</p>
            </div>
            <div id="idleBadge" class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-full bg-surface-dark border border-white/10 pl-3 pr-4 shadow-lg backdrop-blur-md">
              <span class="material-symbols-outlined text-neutral-400 text-[18px]">pause_circle</span>
              <p class="text-neutral-400 text-xs font-bold uppercase tracking-wider">å¾…æ©Ÿä¸­</p>
            </div>
          </div>
        </div>
      </div>

      <!-- æ•¸æ“šé¡¯ç¤º -->
      <div class="flex flex-col items-center justify-start flex-1 px-6 -mt-2 z-10 overflow-y-auto">
        <div class="flex flex-col items-center mb-6 mt-4">
          <span class="text-neutral-500 dark:text-neutral-400 text-xs font-bold uppercase tracking-[0.2em] mb-1">è¡Œç¨‹</span>
          <h1 id="tripName" class="text-neutral-900 dark:text-white text-2xl font-bold leading-none tracking-tight text-center">
            ç­‰å¾…é–‹å§‹
          </h1>
        </div>

        <div class="w-full grid grid-cols-2 gap-4 mb-6">
          <div class="flex flex-col gap-1 rounded-2xl p-5 bg-white dark:bg-surface-dark border border-neutral-200 dark:border-white/5 shadow-sm">
            <div class="flex items-center gap-2 mb-1">
              <span class="material-symbols-outlined text-primary text-[20px]">route</span>
              <p class="text-neutral-500 dark:text-neutral-400 text-xs font-bold uppercase tracking-wider">æœ¬è¶Ÿé‡Œç¨‹</p>
            </div>
            <div class="distance-display text-neutral-900 dark:text-white tabular-nums">
              <span id="tripDist" class="number">0.000</span>
              <span class="unit text-neutral-500 dark:text-neutral-400">km</span>
            </div>
          </div>
          
          <div class="flex flex-col gap-1 rounded-2xl p-5 bg-white dark:bg-surface-dark border border-neutral-200 dark:border-white/5 shadow-sm">
            <div class="flex items-center gap-2 mb-1">
              <span class="material-symbols-outlined text-primary text-[20px]">speed</span>
              <p class="text-neutral-500 dark:text-neutral-400 text-xs font-bold uppercase tracking-wider">ç´¯ç©é‡Œç¨‹</p>
            </div>
            <div class="distance-display text-neutral-900 dark:text-white tabular-nums">
              <span id="currentOdo" class="number">â€”</span>
              <span class="unit text-neutral-500 dark:text-neutral-400">km</span>
            </div>
          </div>
        </div>

        <div class="flex items-center gap-6 text-neutral-500 dark:text-neutral-400 mb-6">
          <div class="flex flex-col items-center">
            <span class="text-[10px] uppercase font-bold tracking-widest mb-0.5">ç²¾ç¢ºåº¦</span>
            <span id="acc" class="text-sm font-semibold text-white">â€”</span>
          </div>
          <div class="w-px h-6 bg-white/10"></div>
          <div class="flex flex-col items-center">
            <span class="text-[10px] uppercase font-bold tracking-widest mb-0.5">é€Ÿåº¦</span>
            <span id="spd" class="text-sm font-semibold text-white">â€”</span>
          </div>
          <div class="w-px h-6 bg-white/10"></div>
          <div class="flex flex-col items-center">
            <span class="text-[10px] uppercase font-bold tracking-widest mb-0.5">æ›´æ–°</span>
            <span id="ts" class="text-sm font-semibold text-white">â€”</span>
          </div>
        </div>
      </div>

      <!-- æ§åˆ¶å€ -->
      <div class="relative w-full pb-8 pt-4 px-6 flex flex-col items-center justify-end shrink-0 z-20">
        <div id="ripple1" class="hidden absolute bottom-[5.5rem] left-1/2 -translate-x-1/2 w-24 h-24 rounded-full bg-primary/20 animate-ripple z-0 pointer-events-none"></div>
        <div id="ripple2" class="hidden absolute bottom-[5.5rem] left-1/2 -translate-x-1/2 w-24 h-24 rounded-full bg-primary/10 animate-ripple z-0 pointer-events-none" style="animation-delay: 1s;"></div>
        
        <div class="flex items-center gap-6 relative z-10">
          <button onclick="showView('history')" class="group flex items-center justify-center w-14 h-14 rounded-full bg-surface-dark border border-white/10 text-white shadow-lg active:scale-95 transition-transform">
            <span class="material-symbols-outlined text-[28px] group-hover:text-primary transition-colors">history</span>
          </button>
          
          <button id="mainBtn" onclick="handleMainButton()" class="relative flex items-center justify-center w-24 h-24 rounded-full bg-primary text-black shadow-xl shadow-primary/20 active:scale-95 transition-all duration-200 group">
            <div class="flex flex-col items-center gap-1">
              <span id="mainBtnIcon" class="material-symbols-outlined text-[32px]">play_circle</span>
              <span id="mainBtnText" class="text-[10px] font-bold uppercase tracking-wider">é–‹å§‹</span>
            </div>
          </button>
          
          <button onclick="showView('settings')" class="group flex items-center justify-center w-14 h-14 rounded-full bg-surface-dark border border-white/10 text-white shadow-lg active:scale-95 transition-transform">
            <span class="material-symbols-outlined text-[28px] group-hover:text-primary transition-colors">settings</span>
          </button>
        </div>
        
        <p id="mainBtnHint" class="text-neutral-500 text-xs mt-6 font-medium">é»æ“Šé–‹å§‹è¨˜éŒ„è¡Œç¨‹</p>
      </div>
    </div>

    <!-- æ­·å²è¨˜éŒ„ç•«é¢ -->
    <div id="viewHistory" class="hidden flex-1 flex flex-col p-6 overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-bold text-white">æ­·å²è¨˜éŒ„</h2>
          <p id="tripCount" class="text-sm text-neutral-400 mt-1">å…± 0 ç­†</p>
        </div>
        <button onclick="exportXLSX()" class="flex items-center gap-2 px-4 py-2 bg-primary text-black rounded-full font-semibold text-sm hover:bg-primary/90 transition-colors">
          <span class="material-symbols-outlined text-[20px]">download</span>
          åŒ¯å‡º
        </button>
      </div>
      
      <div id="tripList" class="space-y-3">
        <div class="text-center py-12 text-neutral-500">
          <span class="material-symbols-outlined text-[48px] opacity-30">folder_open</span>
          <p class="mt-2">å°šç„¡è¡Œç¨‹è¨˜éŒ„</p>
          <p class="text-xs mt-1">é–‹å§‹è¨˜éŒ„å¾Œæœƒé¡¯ç¤ºåœ¨é€™è£¡</p>
        </div>
      </div>
    </div>

    <!-- è¨­å®šç•«é¢ -->
    <div id="viewSettings" class="hidden flex-1 flex flex-col p-6 overflow-y-auto">
      <h2 class="text-2xl font-bold text-white mb-6">è¨­å®š</h2>
      
      <div class="space-y-4 mb-6">
        <div class="bg-surface-dark rounded-2xl p-4 border border-white/5">
          <label class="block text-sm font-semibold text-neutral-400 mb-2">è»Šç‰Œè™Ÿç¢¼</label>
          <input id="plate" type="text" placeholder="ä¾‹ï¼šABC-1234" class="w-full bg-background-dark border border-white/10 rounded-lg px-4 py-3 text-white placeholder-neutral-500 focus:outline-none focus:border-primary transition-colors"/>
        </div>
        
        <div class="bg-surface-dark rounded-2xl p-4 border border-white/5">
          <label class="block text-sm font-semibold text-neutral-400 mb-2">é§•é§›äºº</label>
          <input id="driver" type="text" placeholder="ä¾‹ï¼šç‹å°æ˜" class="w-full bg-background-dark border border-white/10 rounded-lg px-4 py-3 text-white placeholder-neutral-500 focus:outline-none focus:border-primary transition-colors"/>
        </div>
        
        <div class="bg-surface-dark rounded-2xl p-4 border border-white/5">
          <label class="block text-sm font-semibold text-neutral-400 mb-2">ç”³è«‹äººå§“å</label>
          <input id="personName" type="text" placeholder="ä¾‹ï¼šé»ƒå£«æº" class="w-full bg-background-dark border border-white/10 rounded-lg px-4 py-3 text-white placeholder-neutral-500 focus:outline-none focus:border-primary transition-colors"/>
        </div>
        
        <div class="bg-surface-dark rounded-2xl p-4 border border-white/5">
          <label class="block text-sm font-semibold text-neutral-400 mb-2">èµ·å§‹é‡Œç¨‹æ•¸ï¼ˆkmï¼‰</label>
          <input id="startOdo" type="number" inputmode="decimal" step="0.1" placeholder="ä¾‹ï¼š12035.6" class="w-full bg-background-dark border border-white/10 rounded-lg px-4 py-3 text-white placeholder-neutral-500 focus:outline-none focus:border-primary transition-colors"/>
        </div>
        
        <!-- é‡Œç¨‹æ ¡æ­£ä¿‚æ•¸ï¼ˆéš±è—ï¼‰ -->
        <div class="hidden">
          <input id="distCoef" type="number" value="1.10"/>
          <input id="enablePreciseCalc" type="checkbox"/>
        </div>
        
        <!-- ç²¾ç®—é¸é …ï¼ˆéš±è—ï¼‰ -->
      </div>

      <!-- é˜²è­·æ¨¡å¼è¨­å®š -->
      <div class="bg-primary/10 border border-primary/30 rounded-2xl p-4 mb-6">
        <h3 class="text-sm font-bold text-primary mb-3 flex items-center gap-2">
          <span class="material-symbols-outlined text-[20px]">shield</span>
          çµ‚æ¥µé˜²è­·æ¨¡å¼
        </h3>
        <p class="text-xs text-neutral-300 mb-4">
          å•Ÿç”¨å¤šé‡æŠ€è¡“ç¢ºä¿é•·é€”è¡Œç¨‹ç©©å®šé‹è¡Œï¼š<br/>
          â€¢ Wake Lock é˜²ä¼‘çœ <br/>
          â€¢ éœéŸ³éŸ³é »ä¿æ´»<br/>
          â€¢ è‡ªå‹•å‚™ä»½ï¼ˆæ¯ 10 ç§’ï¼‰<br/>
          â€¢ GPS å¥åº·ç›£æ§<br/>
          â€¢ æ–·ç·šè‡ªå‹•é‡é€£
        </p>
        <div class="flex items-center justify-between">
          <span class="text-sm font-semibold text-white">å•Ÿç”¨çµ‚æ¥µé˜²è­·</span>
          <div class="relative">
            <input type="checkbox" id="ultimateMode" class="sr-only peer" checked onchange="toggleUltimateMode()">
            <div class="w-11 h-6 bg-neutral-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-neutral-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
          </div>
        </div>
      </div>

      <div class="space-y-3">
        <button onclick="testGPS()" class="w-full flex items-center justify-center gap-2 px-6 py-4 bg-primary/20 border border-primary text-primary rounded-2xl font-semibold hover:bg-primary/30 transition-colors">
          <span class="material-symbols-outlined">gps_fixed</span>
          æ¸¬è©¦ GPS é€£ç·š
        </button>
        
        <button onclick="testProtections()" class="w-full flex items-center justify-center gap-2 px-6 py-4 bg-blue-600/20 border border-blue-600 text-blue-400 rounded-2xl font-semibold hover:bg-blue-600/30 transition-colors">
          <span class="material-symbols-outlined">verified_user</span>
          æ¸¬è©¦é˜²è­·ç³»çµ±
        </button>
        
        <button onclick="resetAll()" class="w-full flex items-center justify-center gap-2 px-6 py-4 bg-red-600 text-white rounded-2xl font-semibold hover:bg-red-700 transition-colors">
          <span class="material-symbols-outlined">delete</span>
          æ¸…é™¤æ‰€æœ‰è¨˜éŒ„
        </button>
        
        <button onclick="showView('recording')" class="w-full flex items-center justify-center gap-2 px-6 py-4 bg-surface-dark border border-white/10 text-white rounded-2xl font-semibold hover:bg-white/5 transition-colors">
          <span class="material-symbols-outlined">arrow_back</span>
          è¿”å›è¨˜éŒ„
        </button>
      </div>
    </div>

  </div>

  <!-- Toast -->
  <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-24 bg-black/90 text-white px-6 py-3 rounded-full text-sm font-medium shadow-lg backdrop-blur-md opacity-0 transition-opacity duration-300 pointer-events-none z-50"></div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // çµ‚æ¥µç‰ˆ GPS ç³»çµ± - å¤šé‡é˜²è­·æ©Ÿåˆ¶
    
    const $ = (id) => document.getElementById(id);
    
    function toast(msg, duration = 2000) {
      const t = $('toast');
      t.textContent = msg;
      t.style.opacity = '1';
      setTimeout(() => { t.style.opacity = '0'; }, duration);
    }
    
    function showCoefInfo() {
      const info = `ğŸ“Š é‡Œç¨‹æ ¡æ­£ä¿‚æ•¸èªªæ˜

ç‚ºä»€éº¼éœ€è¦ï¼Ÿ
GPS è¨ˆç®—çš„æ˜¯ã€Œç›´ç·šè·é›¢ã€ï¼Œä½†è»Šå­å¯¦éš›èµ°çš„æ˜¯ã€Œé“è·¯è·é›¢ã€ï¼Œé“è·¯æœ‰å½é“ã€è¿´è½‰ï¼Œæ‰€ä»¥æœƒå°‘ç®—ã€‚

å¦‚ä½•è¨­å®šï¼Ÿ
1. è·‘ä¸€è¶Ÿå·²çŸ¥è·é›¢çš„è·¯ç·šï¼ˆä¾‹å¦‚é€šå‹¤ï¼‰
2. æ¯”è¼ƒè»Šå­å„€è¡¨æ¿å’Œ GPS é¡¯ç¤º
3. è¨ˆç®—ï¼šä¿‚æ•¸ = å„€è¡¨æ¿ Ã· GPS
4. è¼¸å…¥åˆ°é€™è£¡

ç¯„ä¾‹ï¼š
â€¢ å„€è¡¨æ¿ï¼š30.0 km
â€¢ GPS é¡¯ç¤ºï¼š27.0 km
â€¢ ä¿‚æ•¸ï¼š30 Ã· 27 = 1.11

å»ºè­°å€¼ï¼š
â€¢ é«˜é€Ÿå…¬è·¯ï¼š1.05
â€¢ ä¸€èˆ¬é“è·¯ï¼š1.10ï¼ˆé è¨­ï¼‰
â€¢ å±±è·¯å½é“ï¼š1.15

é è¨­ 1.10 å¯è£œå„Ÿç´„ 10% èª¤å·®ã€‚`;
      
      alert(info);
    }
    
    async function calculateRoadDistance(startLat, startLng, endLat, endLng) {
      // ä½¿ç”¨ OSRM API è¨ˆç®—å¯¦éš›é“è·¯è·é›¢
      const start = `${startLng},${startLat}`;
      const end = `${endLng},${endLat}`;
      const url = `https://router.project-osrm.org/route/v1/driving/${start};${end}?overview=false`;
      
      try {
        const response = await fetch(url, { timeout: 10000 });
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        if (data.code !== 'Ok' || !data.routes || !data.routes[0]) {
          throw new Error('è·¯ç·šè¨ˆç®—å¤±æ•—');
        }
        
        const distanceMeters = data.routes[0].distance;
        return distanceMeters / 1000; // è½‰æ›ç‚ºå…¬é‡Œ
      } catch (err) {
        console.error('OSRM API éŒ¯èª¤ï¼š', err);
        throw err;
      }
    }
    
    function fmt(n, d = 6) {
      return (n == null || Number.isNaN(n)) ? "â€”" : Number(n).toFixed(d);
    }
    
    function kph(mps) {
      return (mps == null || Number.isNaN(mps)) ? null : mps * 3.6;
    }
    
    function tsFmt(d) {
      const p = (x) => String(x).padStart(2, '0');
      return `${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
    }
    
    function hav(a, b) {
      const R = 6371000, toRad = x => x * Math.PI / 180;
      const dLat = toRad(b.lat - a.lat), dLng = toRad(b.lng - a.lng);
      const s1 = Math.sin(dLat / 2), s2 = Math.sin(dLng / 2);
      const aa = s1 * s1 + Math.cos(toRad(a.lat)) * Math.cos(toRad(b.lat)) * s2 * s2;
      return 2 * R * Math.atan2(Math.sqrt(aa), Math.sqrt(1 - aa));
    }
    
    function tripTitle(a, b) {
      a = (a || '').trim();
      b = (b || '').trim();
      return (a && b) ? `${a} â†’ ${b}` : (a || b || '');
    }
    
    function requireNonEmpty(promptText, defVal) {
      while (true) {
        let v = window.prompt(promptText, defVal) || "";
        v = v.trim();
        if (v !== "") return v;
        if (!window.confirm("åç¨±ä¸èƒ½ç©ºç™½ï¼Œæ˜¯å¦é‡æ–°è¼¸å…¥ï¼Ÿ")) return null;
      }
    }

    // ========== ç‹€æ…‹ç®¡ç† ==========
    let watchId = null, last = null, tripActive = false, tripDist = 0, tripStartPos = null;
    let tripStartTime = null, tripStartName = "", tripEndName = "";
    let trips = [];
    let map, marker, circle, track;
    
    // ========== çµ‚æ¥µé˜²è­·ç³»çµ± ==========
    let ultimateMode = true;
    let lastGPSUpdate = Date.now();
    let reconnectCount = 0;
    let totalPoints = 0;
    let wakeupCount = 0;
    let autoSaveCount = 0;
    let tripStartRealTime = null;
    
    // å¤šé‡é˜²è­·çµ„ä»¶
    let wakeLockSentinel = null;
    let silentAudio = null;
    let healthCheckInterval = null;
    let autoSaveInterval = null;
    let batteryMonitor = null;
    let runningTimeInterval = null;
    
    // é˜²è­·ç‹€æ…‹
    const protectionStatus = {
      wakeLock: false,
      audio: false,
      autoSave: false,
      battery: 100
    };

    // ========== 1. Wake Lock é˜²ä¼‘çœ  ==========
    async function startWakeLock() {
      if (!('wakeLock' in navigator)) {
        console.log('Wake Lock ä¸æ”¯æ´');
        return false;
      }
      
      try {
        wakeLockSentinel = await navigator.wakeLock.request('screen');
        protectionStatus.wakeLock = true;
        updateProtectionUI('wakeLock', true);
        console.log('âœ“ Wake Lock å·²å•Ÿå‹•');
        
        wakeLockSentinel.addEventListener('release', () => {
          protectionStatus.wakeLock = false;
          updateProtectionUI('wakeLock', false);
          console.log('Wake Lock å·²é‡‹æ”¾ï¼Œå˜—è©¦é‡æ–°è«‹æ±‚...');
          if (ultimateMode && tripActive) {
            setTimeout(() => startWakeLock(), 1000);
          }
        });
        
        return true;
      } catch (err) {
        console.error('Wake Lock å¤±æ•—ï¼š', err);
        updateProtectionUI('wakeLock', false);
        return false;
      }
    }
    
    async function stopWakeLock() {
      if (wakeLockSentinel) {
        try {
          await wakeLockSentinel.release();
          wakeLockSentinel = null;
          protectionStatus.wakeLock = false;
          updateProtectionUI('wakeLock', false);
        } catch (err) {
          console.error('é‡‹æ”¾ Wake Lock å¤±æ•—ï¼š', err);
        }
      }
    }

    // ========== 2. éœéŸ³éŸ³é »ä¿æ´»ï¼ˆiOS å°ˆç”¨ï¼‰ ==========
    function startAudioKeepAlive() {
      silentAudio = $('silentAudio');
      if (!silentAudio) {
        console.log('éŸ³é »å…ƒç´ ä¸å­˜åœ¨');
        return false;
      }
      
      try {
        silentAudio.play().then(() => {
          protectionStatus.audio = true;
          updateProtectionUI('audio', true);
          console.log('âœ“ éœéŸ³éŸ³é »å·²å•Ÿå‹•');
        }).catch(err => {
          console.error('éŸ³é »æ’­æ”¾å¤±æ•—ï¼š', err);
          updateProtectionUI('audio', false);
          
          // iOS éœ€è¦ç”¨æˆ¶äº’å‹•æ‰èƒ½æ’­æ”¾ï¼Œç›£è½ä¸‹ä¸€æ¬¡é»æ“Š
          document.addEventListener('click', function retryAudio() {
            silentAudio.play().then(() => {
              protectionStatus.audio = true;
              updateProtectionUI('audio', true);
              console.log('âœ“ éœéŸ³éŸ³é »å·²å•Ÿå‹•ï¼ˆç”¨æˆ¶äº’å‹•å¾Œï¼‰');
              document.removeEventListener('click', retryAudio);
            });
          }, { once: true });
        });
        return true;
      } catch (err) {
        console.error('éŸ³é »å•Ÿå‹•å¤±æ•—ï¼š', err);
        return false;
      }
    }
    
    function stopAudioKeepAlive() {
      if (silentAudio) {
        silentAudio.pause();
        protectionStatus.audio = false;
        updateProtectionUI('audio', false);
      }
    }

    // ========== 3. è‡ªå‹•å‚™ä»½ç³»çµ± ==========
    function startAutoSave() {
      if (autoSaveInterval) clearInterval(autoSaveInterval);
      
      autoSaveInterval = setInterval(() => {
        if (tripActive) {
          saveCurrentTrip();
          autoSaveCount++;
          updateStats();
          console.log(`è‡ªå‹•å‚™ä»½ #${autoSaveCount}`);
        }
      }, 10000); // æ¯ 10 ç§’å‚™ä»½
      
      protectionStatus.autoSave = true;
      updateProtectionUI('autoSave', true);
      console.log('âœ“ è‡ªå‹•å‚™ä»½å·²å•Ÿå‹•ï¼ˆæ¯ 10 ç§’ï¼‰');
    }
    
    function stopAutoSave() {
      if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
        autoSaveInterval = null;
        protectionStatus.autoSave = false;
        updateProtectionUI('autoSave', false);
      }
    }
    
    function saveCurrentTrip() {
      if (!tripActive) return;
      
      const currentTrip = {
        startName: tripStartName,
        endName: tripEndName,
        start: tripStartTime,
        km: tripDist / 1000,
        points: totalPoints,
        reconnects: reconnectCount,
        timestamp: Date.now()
      };
      
      try {
        localStorage.setItem('gps_current_trip_backup', JSON.stringify(currentTrip));
        return true;
      } catch (e) {
        console.error('è‡ªå‹•å‚™ä»½å¤±æ•—ï¼š', e);
        return false;
      }
    }
    
    function loadCurrentTripBackup() {
      try {
        const backup = localStorage.getItem('gps_current_trip_backup');
        if (backup) {
          const trip = JSON.parse(backup);
          // æª¢æŸ¥æ˜¯å¦åœ¨ 1 å°æ™‚å…§
          if (Date.now() - trip.timestamp < 3600000) {
            return trip;
          }
        }
      } catch (e) {
        console.error('è®€å–å‚™ä»½å¤±æ•—ï¼š', e);
      }
      return null;
    }
    
    function clearCurrentTripBackup() {
      localStorage.removeItem('gps_current_trip_backup');
    }

    // ========== 4. GPS å¥åº·æª¢æŸ¥ ==========
    function startHealthCheck() {
      if (healthCheckInterval) clearInterval(healthCheckInterval);
      
      healthCheckInterval = setInterval(() => {
        if (!tripActive) {
          stopHealthCheck();
          return;
        }
        
        const timeSinceLastUpdate = Date.now() - lastGPSUpdate;
        
        if (timeSinceLastUpdate > 15000) {
          updateConnectionStatus('error', 'ä¸­æ–·');
          showWarning();
          
          if (reconnectCount < 999 && ultimateMode) {
            reconnectGPS();
          }
        } else if (timeSinceLastUpdate > 8000) {
          updateConnectionStatus('warning', 'ä¸ç©©');
        } else {
          updateConnectionStatus('ok', 'æ­£å¸¸');
          hideWarning();
        }
      }, 5000);
    }
    
    function stopHealthCheck() {
      if (healthCheckInterval) {
        clearInterval(healthCheckInterval);
        healthCheckInterval = null;
      }
    }

    // ========== 5. é›»æ± ç›£æ§ ==========
    async function startBatteryMonitor() {
      if (!('getBattery' in navigator)) {
        console.log('é›»æ±  API ä¸æ”¯æ´');
        return;
      }
      
      try {
        const battery = await navigator.getBattery();
        
        function updateBatteryUI() {
          const level = Math.round(battery.level * 100);
          const charging = battery.charging;
          
          protectionStatus.battery = level;
          
          const batteryEl = $('batteryStatus');
          const batteryIcon = $('batteryIcon');
          const batteryText = $('batteryText');
          
          if (level <= 20 && !charging) {
            batteryIcon.textContent = 'battery_alert';
            batteryIcon.className = 'material-symbols-outlined text-red-500 text-[16px]';
            batteryText.className = 'text-xs font-bold text-red-500 tracking-wider';
          } else if (charging) {
            batteryIcon.textContent = 'battery_charging_full';
            batteryIcon.className = 'material-symbols-outlined text-primary text-[16px]';
            batteryText.className = 'text-xs font-bold text-primary tracking-wider';
          } else {
            batteryIcon.textContent = level > 50 ? 'battery_full' : 'battery_3_bar';
            batteryIcon.className = 'material-symbols-outlined text-primary text-[16px]';
            batteryText.className = 'text-xs font-bold text-primary tracking-wider';
          }
          
          batteryText.textContent = `${level}%`;
          batteryEl.classList.remove('hidden');
          batteryEl.classList.add('flex');
          
          // æ›´æ–°å´é‚Šæ¬„
          const statusBattery = $('status-battery');
          if (statusBattery) {
            const statusText = statusBattery.querySelector('.text-white');
            if (statusText) {
              statusText.textContent = charging ? `${level}% (å……é›»ä¸­)` : `${level}%`;
            }
          }
        }
        
        battery.addEventListener('levelchange', updateBatteryUI);
        battery.addEventListener('chargingchange', updateBatteryUI);
        updateBatteryUI();
        
        console.log('âœ“ é›»æ± ç›£æ§å·²å•Ÿå‹•');
      } catch (err) {
        console.error('é›»æ± ç›£æ§å¤±æ•—ï¼š', err);
      }
    }

    // ========== 6. é‹è¡Œæ™‚é•·è¨ˆæ™‚å™¨ ==========
    function startRunningTimer() {
      if (runningTimeInterval) clearInterval(runningTimeInterval);
      
      tripStartRealTime = Date.now();
      
      runningTimeInterval = setInterval(() => {
        if (!tripActive) {
          stopRunningTimer();
          return;
        }
        
        const elapsed = Date.now() - tripStartRealTime;
        const hours = Math.floor(elapsed / 3600000);
        const minutes = Math.floor((elapsed % 3600000) / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        
        const timeStr = `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
        $('runningTime').textContent = timeStr;
      }, 1000);
    }
    
    function stopRunningTimer() {
      if (runningTimeInterval) {
        clearInterval(runningTimeInterval);
        runningTimeInterval = null;
      }
    }

    // ========== é é¢å¯è¦‹æ€§è™•ç† ==========
    document.addEventListener('visibilitychange', async () => {
      if (document.visibilityState === 'visible' && tripActive && ultimateMode) {
        wakeupCount++;
        updateStats();
        console.log('é é¢é‡æ–°å¯è¦‹ï¼ŒåŸ·è¡Œå®Œæ•´æª¢æŸ¥...');
        
        // æª¢æŸ¥ä¸¦æ¢å¾©æ‰€æœ‰é˜²è­·
        if (!protectionStatus.wakeLock) {
          await startWakeLock();
        }
        
        if (!protectionStatus.audio && silentAudio) {
          startAudioKeepAlive();
        }
        
        // æª¢æŸ¥ GPS
        const timeSinceLastUpdate = Date.now() - lastGPSUpdate;
        if (timeSinceLastUpdate > 10000) {
          console.log('GPS å¯èƒ½ä¸­æ–·ï¼Œå˜—è©¦é‡æ–°é€£ç·š...');
          reconnectGPS();
        }
        
        toast('âœ“ ç³»çµ±å·²æ¢å¾©', 2000);
      }
    });

    // ========== GPS é‡æ–°é€£ç·š ==========
    function reconnectGPS() {
      if (!tripActive || !ultimateMode) return;
      
      reconnectCount++;
      updateStats();
      
      console.log(`GPS é‡æ–°é€£ç·š #${reconnectCount}...`);
      toast(`æ­£åœ¨é‡æ–°é€£ç·š GPS...`, 2000);
      
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      
      setTimeout(() => {
        startWatch();
      }, 1000);
    }

    // ========== æ›´æ–°é˜²è­· UI ==========
    function updateProtectionUI(protection, active) {
      const indicators = {
        wakeLock: {
          banner: 'protection-wakeLock',
          sidebar: 'status-wakeLock',
          name: 'Wake Lock',
          activeText: 'âœ“ å·²å•Ÿå‹•',
          inactiveText: 'âœ— æœªå•Ÿå‹•'
        },
        audio: {
          banner: 'protection-audio',
          sidebar: 'status-audio',
          name: 'éŸ³é »ä¿æ´»',
          activeText: 'âœ“ é‹è¡Œä¸­',
          inactiveText: 'âœ— æœªé‹è¡Œ'
        },
        autoSave: {
          banner: 'protection-localStorage',
          sidebar: 'status-autoSave',
          name: 'è‡ªå‹•å„²å­˜',
          activeText: 'âœ“ æ¯ 10 ç§’',
          inactiveText: 'âœ— æœªå•Ÿå‹•'
        }
      };
      
      const config = indicators[protection];
      if (!config) return;
      
      // æ›´æ–°æ©«å¹…
      const bannerEl = $(config.banner);
      if (bannerEl) {
        const dot = bannerEl.querySelector('.w-2');
        const text = bannerEl.querySelector('span:last-child');
        if (dot) {
          dot.className = `w-2 h-2 rounded-full ${active ? 'bg-primary' : 'bg-red-500'}`;
        }
        if (text) {
          text.textContent = `${config.name}: ${active ? config.activeText : config.inactiveText}`;
        }
      }
      
      // æ›´æ–°å´é‚Šæ¬„
      const sidebarEl = $(config.sidebar);
      if (sidebarEl) {
        const statusText = sidebarEl.querySelector('.text-white');
        if (statusText) {
          statusText.textContent = active ? config.activeText : config.inactiveText;
          statusText.className = `text-xs font-semibold ${active ? 'text-primary' : 'text-red-500'}`;
        }
      }
    }

    // ========== UI è¼”åŠ©å‡½æ•¸ ==========
    function showView(view) {
      const views = ['viewRecording', 'viewHistory', 'viewSettings'];
      views.forEach(v => {
        $(v).classList.toggle('hidden', v !== 'view' + view.charAt(0).toUpperCase() + view.slice(1));
      });
      
      if (view === 'history') {
        renderTrips();
      }
    }
    
    function toggleMenu() {
      $('sideMenu').classList.toggle('hidden');
      updateStats();
    }
    
    function toggleSettings() {
      showView('settings');
    }
    
    function toggleUltimateMode() {
      ultimateMode = $('ultimateMode').checked;
      toast(ultimateMode ? 'âœ“ çµ‚æ¥µé˜²è­·å·²å•Ÿç”¨' : 'âœ“ çµ‚æ¥µé˜²è­·å·²é—œé–‰', 2000);
      
      if (ultimateMode && tripActive) {
        startAllProtections();
      } else if (!ultimateMode && tripActive) {
        stopAllProtections();
      }
      
      localStorage.setItem('gps_ultimate_mode', ultimateMode.toString());
    }
    
    function toggleProtectionBanner() {
      // å¯¦ä½œæ”¶åˆæ©«å¹…åŠŸèƒ½
      const banner = $('protectionBanner');
      const details = banner.querySelector('.space-y-0\\.5');
      const btn = banner.querySelector('button span');
      
      if (details.style.display === 'none') {
        details.style.display = 'block';
        btn.textContent = 'expand_less';
      } else {
        details.style.display = 'none';
        btn.textContent = 'expand_more';
      }
    }
    
    function showWarning() {
      $('warningBanner').classList.remove('hidden');
    }
    
    function hideWarning() {
      $('warningBanner').classList.add('hidden');
    }
    
    function dismissWarning() {
      hideWarning();
    }
    
    function updateStats() {
      $('pointCount').textContent = totalPoints;
      $('lastUpdateTime').textContent = tsFmt(new Date(lastGPSUpdate));
      $('reconnectCount').textContent = reconnectCount;
      $('wakeupCount').textContent = wakeupCount;
      $('autoSaveCount').textContent = `${autoSaveCount} æ¬¡`;
    }

    // ========== æ™ºæ…§æ•¸å­—ç¸®æ”¾ç³»çµ± ==========
    function smartScaleNumber(elementId) {
      const numberEl = $(elementId);
      if (!numberEl) return;
      
      const container = numberEl.parentElement;
      const unitEl = container.querySelector('.unit');
      
      // ç²å–å®¹å™¨å¯¦éš›å¯ç”¨å¯¬åº¦
      const containerWidth = container.clientWidth;
      const unitWidth = unitEl ? unitEl.offsetWidth : 30;
      const gap = 4; // 0.25rem
      const availableWidth = containerWidth - unitWidth - gap - 10; // æ¸›10px padding
      
      // é‡ç½®ç‚ºæœ€å¤§å­—é«”
      numberEl.style.fontSize = '3rem'; // 48px
      
      // å¼·åˆ¶é‡æ–°è¨ˆç®—
      void numberEl.offsetWidth;
      
      // ç²å–å¯¦éš›æ–‡å­—å¯¬åº¦
      const textWidth = numberEl.scrollWidth;
      
      if (textWidth > availableWidth) {
        // è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹
        const scale = availableWidth / textWidth;
        const baseFontSize = 48;
        let newFontSize = baseFontSize * scale;
        
        // ç¢ºä¿æœ€å°å­—é«”
        newFontSize = Math.max(16, newFontSize);
        
        numberEl.style.fontSize = newFontSize + 'px';
        
        // æ›´æ–°å–®ä½å­—é«”ï¼ˆä¿æŒæ¯”ä¾‹ï¼‰
        if (unitEl) {
          const unitSize = Math.max(12, newFontSize * 0.4);
          unitEl.style.fontSize = unitSize + 'px';
        }
        
        console.log(`[ç¸®æ”¾] ${elementId}: ${baseFontSize}px â†’ ${newFontSize.toFixed(1)}px (${(scale*100).toFixed(1)}%)`);
      } else {
        // ä¿æŒåŸå§‹å¤§å°
        numberEl.style.fontSize = '3rem';
        if (unitEl) {
          unitEl.style.fontSize = '1.125rem';
        }
      }
    }

    // ========== GPS ç›¸é—œ ==========
    function updateConnectionStatus(status, text) {
      const statusEl = $('connectionStatus');
      const icon = $('connectionIcon');
      const textEl = $('connectionText');
      
      const configs = {
        ok: { icon: 'check_circle', color: 'text-primary', text: text || 'æ­£å¸¸' },
        warning: { icon: 'warning', color: 'text-yellow-400', text: text || 'ä¸ç©©' },
        error: { icon: 'error', color: 'text-red-500', text: text || 'ä¸­æ–·' }
      };
      
      const config = configs[status] || configs.ok;
      icon.textContent = config.icon;
      icon.className = `material-symbols-outlined ${config.color} text-[16px]`;
      textEl.className = `text-xs font-bold ${config.color} tracking-wider`;
      textEl.textContent = config.text;
    }
    
    function updateGPSStatus(status, text) {
      const statusEl = $('gpsStatus');
      const icon = statusEl.querySelector('.material-symbols-outlined');
      const textEl = statusEl.querySelector('span:last-child');
      
      const colors = {
        idle: 'text-neutral-500',
        active: 'text-primary',
        error: 'text-red-500'
      };
      
      icon.className = `material-symbols-outlined ${colors[status] || colors.idle} text-[16px]`;
      textEl.className = `text-xs font-bold ${colors[status] || colors.idle} tracking-wider`;
      textEl.textContent = text;
    }
    
    function renderCurrentOdo() {
      const startOdoStr = ($('startOdo').value || '').trim();
      if (startOdoStr === "") {
        $('currentOdo').textContent = "â€”";
        smartScaleNumber('currentOdo');
        return;
      }
      const startOdo = parseFloat(startOdoStr);
      if (isNaN(startOdo)) {
        $('currentOdo').textContent = "â€”";
        smartScaleNumber('currentOdo');
        return;
      }
      const current = startOdo + (tripDist / 1000);
      $('currentOdo').textContent = fmt(current, 3);
      smartScaleNumber('currentOdo');
    }
    
    function updateUI(pos) {
      const { latitude: lat, longitude: lng, accuracy: acc, speed } = pos.coords;
      const cur = { lat, lng };
      
      lastGPSUpdate = Date.now();
      totalPoints++;
      updateConnectionStatus('ok', 'æ­£å¸¸');
      hideWarning();
      
      $('acc').textContent = acc ? `${fmt(acc, 0)}m` : 'â€”';
      $('spd').textContent = speed !== null ? `${fmt(kph(speed), 1)} km/h` : 'â€”';
      $('ts').textContent = tsFmt(new Date(pos.timestamp));
      
      if (map && marker && circle) {
        marker.setLatLng([lat, lng]);
        circle.setLatLng([lat, lng]);
        circle.setRadius(Math.max(acc, 10));
        
        if (tripActive) {
          map.setView([lat, lng], Math.max(map.getZoom(), 15));
        }
        
        const coords = track.getLatLngs();
        coords.push([lat, lng]);
        track.setLatLngs(coords);
        
        // æ›´æ–°è·¯å¾‘é»æ•¸é¡¯ç¤º
        if (tripActive) {
          $('pathInfoCard').classList.remove('hidden');
          $('pathPointCount').textContent = coords.length;
        }
        
        if (coords.length > 1000) {
          track.setLatLngs(coords.slice(-1000));
        }
      }
      
      if (tripActive && last) {
        const dist = hav(last, cur);
        if (dist > 5) {
          // å¥—ç”¨é‡Œç¨‹æ ¡æ­£ä¿‚æ•¸
          const coef = parseFloat(localStorage.getItem('distCoef') || '1.10');
          tripDist += dist * coef;
          $('tripDist').textContent = fmt(tripDist / 1000, 3);
          smartScaleNumber('tripDist');
          renderCurrentOdo();
        }
      }
      
      last = cur;
    }
    
    function startWatch() {
      if (!('geolocation' in navigator)) {
        updateGPSStatus('error', 'ä¸æ”¯æ´');
        toast('æ­¤è£ç½®ä¸æ”¯æ´ GPS å®šä½', 3000);
        return false;
      }
      
      if (watchId !== null) return true;
      
      updateGPSStatus('active', 'å®šä½ä¸­');
      
      try {
        watchId = navigator.geolocation.watchPosition(
          (pos) => {
            updateGPSStatus('active', 'GPS');
            updateUI(pos);
          },
          (err) => {
            const messages = {
              1: "æ¬Šé™æ‹’çµ•",
              2: "ç„¡æ³•å®šä½",
              3: "é€¾æ™‚"
            };
            const msg = messages[err.code] || 'éŒ¯èª¤';
            updateGPSStatus('error', msg);
            updateConnectionStatus('error', msg);
            showWarning();
            
            if (ultimateMode && tripActive) {
              setTimeout(() => {
                reconnectGPS();
              }, 3000);
            }
          },
          {
            enableHighAccuracy: true,
            maximumAge: 1000,
            timeout: 20000
          }
        );
        
        lastGPSUpdate = Date.now();
        return true;
      } catch (e) {
        console.error(e);
        updateGPSStatus('error', 'å•Ÿå‹•å¤±æ•—');
        toast('GPS å•Ÿå‹•å¤±æ•—', 3000);
        return false;
      }
    }
    
    function stopWatch() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        updateGPSStatus('idle', 'å¾…æ©Ÿ');
        updateConnectionStatus('ok', 'æ­£å¸¸');
      }
    }

    // ========== å•Ÿå‹•/åœæ­¢æ‰€æœ‰é˜²è­· ==========
    async function startAllProtections() {
      console.log('ğŸ›¡ï¸ å•Ÿå‹•çµ‚æ¥µé˜²è­·ç³»çµ±...');
      
      await startWakeLock();
      startAudioKeepAlive();
      startAutoSave();
      startHealthCheck();
      startBatteryMonitor();
      startRunningTimer();
      
      $('protectionBanner').classList.remove('hidden');
      
      toast('âœ“ çµ‚æ¥µé˜²è­·ç³»çµ±å·²å•Ÿå‹•', 3000);
    }
    
    async function stopAllProtections() {
      console.log('ğŸ›¡ï¸ åœæ­¢é˜²è­·ç³»çµ±...');
      
      await stopWakeLock();
      stopAudioKeepAlive();
      stopAutoSave();
      stopHealthCheck();
      stopRunningTimer();
      
      $('protectionBanner').classList.add('hidden');
    }

    // ========== ä¸»è¦æ§åˆ¶ ==========
    function updateMainButton(state) {
      const btn = $('mainBtn');
      const icon = $('mainBtnIcon');
      const text = $('mainBtnText');
      const hint = $('mainBtnHint');
      
      if (state === 'start') {
        btn.className = 'relative flex items-center justify-center w-24 h-24 rounded-full bg-primary text-black shadow-xl shadow-primary/20 active:scale-95 transition-all duration-200 group';
        icon.textContent = 'play_circle';
        text.textContent = 'é–‹å§‹';
        hint.textContent = 'é»æ“Šé–‹å§‹è¨˜éŒ„è¡Œç¨‹';
        $('ripple1').classList.add('hidden');
        $('ripple2').classList.add('hidden');
        $('trackingBadge').classList.add('hidden');
        $('idleBadge').classList.remove('hidden');
      } else if (state === 'stop') {
        btn.className = 'relative flex items-center justify-center w-24 h-24 rounded-full bg-red-600 text-white shadow-xl shadow-red-900/20 active:scale-95 transition-all duration-200 group';
        icon.textContent = 'stop_circle';
        text.textContent = 'åœæ­¢';
        hint.textContent = 'é»æ“Šåœæ­¢ä¸¦è¨˜éŒ„è¡Œç¨‹';
        $('ripple1').classList.remove('hidden');
        $('ripple2').classList.remove('hidden');
        $('trackingBadge').classList.remove('hidden');
        $('idleBadge').classList.add('hidden');
      }
    }
    
    function handleMainButton() {
      if (!tripActive) {
        tripStart();
      } else {
        tripStop();
      }
    }
    
    async function tripStart() {
      if (tripActive) {
        toast('è¡Œç¨‹å·²åœ¨é€²è¡Œä¸­', 2000);
        return;
      }
      
      // æª¢æŸ¥æ˜¯å¦æœ‰å‚™ä»½
      const backup = loadCurrentTripBackup();
      if (backup) {
        if (confirm('åµæ¸¬åˆ°æœªå®Œæˆçš„è¡Œç¨‹å‚™ä»½ï¼Œæ˜¯å¦æ¢å¾©ï¼Ÿ')) {
          tripStartName = backup.startName;
          tripEndName = backup.endName;
          tripStartTime = backup.start;
          tripDist = backup.km * 1000;
          totalPoints = backup.points || 0;
          reconnectCount = backup.reconnects || 0;
          
          toast('âœ“ å·²æ¢å¾©å‚™ä»½è¡Œç¨‹', 3000);
        } else {
          clearCurrentTripBackup();
        }
      }
      
      if (!startWatch()) {
        return;
      }
      
      if (!tripStartName) {
        const startName = requireNonEmpty("è«‹è¼¸å…¥ã€èµ·é»ã€åç¨±\nä¾‹å¦‚ï¼šå…¬å¸ã€å°åŒ—è»Šç«™", "èµ·é»");
        if (startName === null) {
          if (!tripActive) stopWatch();
          return;
        }
        
        const endName = requireNonEmpty("è«‹è¼¸å…¥ã€çµ‚é»ã€åç¨±\nä¾‹å¦‚ï¼šå®¢æˆ¶Aã€æ¡ƒåœ’æ©Ÿå ´", "çµ‚é»");
        if (endName === null) {
          if (!tripActive) stopWatch();
          return;
        }
        
        tripStartName = startName;
        tripEndName = endName;
        tripStartTime = new Date();
      }
      
      tripActive = true;
      if (!tripDist) tripDist = 0;
      if (!totalPoints) totalPoints = 0;
      if (!reconnectCount) reconnectCount = 0;
      autoSaveCount = 0;
      
      // è¨˜éŒ„èµ·é»ä½ç½®ï¼ˆç”¨æ–¼ç²¾ç®—ï¼‰
      if (last) {
        tripStartPos = { lat: last.lat, lng: last.lng };
      }
      
      $('tripDist').textContent = fmt(tripDist / 1000, 3);
      smartScaleNumber('tripDist');
      $('tripName').textContent = `${tripStartName} â†’ ${tripEndName}`;
      renderCurrentOdo();
      
      updateMainButton('stop');
      toast(`âœ“ è¡Œç¨‹å·²é–‹å§‹ï¼š${tripStartName} â†’ ${tripEndName}`, 3000);
      
      if (track && !backup) {
        track.setLatLngs([]);
        if (last) track.addLatLng([last.lat, last.lng]);
      }
      
      if (ultimateMode) {
        await startAllProtections();
      }
    }
    
    async function tripStop() {
      if (!tripActive) {
        toast('å°šæœªé–‹å§‹è¡Œç¨‹', 2000);
        return;
      }
      
      const endTime = new Date();
      let km = tripDist / 1000;
      
      if (km < 0.01) {
        if (!confirm('æœ¬è¶Ÿè¡Œç¨‹é‡Œç¨‹å¹¾ä¹ç‚º 0ï¼Œç¢ºå®šè¦çµæŸå—ï¼Ÿ')) {
          return;
        }
      }
      
      // ç²¾ç®—é“è·¯è·é›¢ï¼ˆå¦‚æœå•Ÿç”¨ä¸”æœ‰ç¶²è·¯ï¼‰
      const enablePreciseCalc = localStorage.getItem('enablePreciseCalc') === 'true';
      if (enablePreciseCalc && last && tripActive) {
        const shouldCalc = confirm('æ˜¯å¦ä½¿ç”¨è·¯ç·š API è¨ˆç®—ç²¾ç¢ºé“è·¯è·é›¢ï¼Ÿ\nï¼ˆéœ€è¦ç¶²è·¯é€£ç·šï¼‰');
        if (shouldCalc) {
          toast('æ­£åœ¨è¨ˆç®—ç²¾ç¢ºè·é›¢...', 5000);
          try {
            const preciseKm = await calculateRoadDistance(
              tripStartPos.lat, tripStartPos.lng,
              last.lat, last.lng
            );
            if (preciseKm > 0) {
              km = preciseKm;
              toast(`âœ“ ç²¾ç¢ºè·é›¢ï¼š${km.toFixed(3)} km`, 3000);
            }
          } catch (err) {
            console.error('ç²¾ç®—å¤±æ•—ï¼š', err);
            toast('âš ï¸ ç²¾ç®—å¤±æ•—ï¼Œä½¿ç”¨ GPS è·é›¢', 3000);
          }
        }
      }
      
      const startOdoStr = ($('startOdo').value || '').trim();
      const startOdo = startOdoStr === '' ? 0 : parseFloat(startOdoStr);
      const odoTotal = (isNaN(startOdo) ? 0 : startOdo) + km;
      
      // å„²å­˜è·¯å¾‘é»ï¼ˆç”¨æ–¼é¡¯ç¤ºè·¯ç·šï¼‰
      const routePoints = track ? track.getLatLngs().map(p => [p.lat, p.lng]) : [];
      
      trips.push({
        startName: tripStartName,
        endName: tripEndName,
        start: tsFmt(tripStartTime),
        end: tsFmt(endTime),
        km: km,
        odoTotal: odoTotal,
        title: tripTitle(tripStartName, tripEndName),
        points: totalPoints,
        reconnects: reconnectCount,
        route: routePoints // æ–°å¢ï¼šå„²å­˜è·¯å¾‘
      });
      
      saveTripsToStorage();
      clearCurrentTripBackup();
      
      tripActive = false;
      tripDist = 0;
      tripStartTime = null;
      tripStartName = "";
      tripEndName = "";
      totalPoints = 0;
      reconnectCount = 0;
      autoSaveCount = 0;
      
      $('tripDist').textContent = '0.000';
      smartScaleNumber('tripDist');
      $('tripName').textContent = 'ç­‰å¾…é–‹å§‹';
      renderCurrentOdo();
      hideWarning();
      
      stopWatch();
      await stopAllProtections();
      
      updateMainButton('start');
      
      // éš±è—è·¯å¾‘è³‡è¨Šå¡ç‰‡
      $('pathInfoCard').classList.add('hidden');
      
      const summary = `âœ“ è¡Œç¨‹å·²è¨˜éŒ„\né‡Œç¨‹ï¼š${km.toFixed(2)} km\nå®šä½é»ï¼š${totalPoints}\né‡é€£æ¬¡æ•¸ï¼š${reconnectCount}`;
      toast(summary, 4000);
    }

    // ========== æ¸¬è©¦åŠŸèƒ½ ==========
    async function testGPS() {
      toast('æ­£åœ¨æ¸¬è©¦ GPS...', 3000);
      
      if (!('geolocation' in navigator)) {
        toast('âŒ æ­¤è£ç½®ä¸æ”¯æ´ GPS', 3000);
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const acc = pos.coords.accuracy;
          const quality = acc < 10 ? 'æ¥µä½³' : acc < 20 ? 'è‰¯å¥½' : acc < 50 ? 'å°šå¯' : 'ä¸ä½³';
          toast(`âœ“ GPS æ­£å¸¸ | ç²¾ç¢ºåº¦ï¼š${acc.toFixed(0)}m (${quality})`, 4000);
        },
        (err) => {
          const msgs = { 1: 'è«‹å…è¨±ä½ç½®æ¬Šé™', 2: 'ç„¡æ³•å–å¾—ä½ç½®', 3: 'å®šä½é€¾æ™‚' };
          toast(`âŒ ${msgs[err.code] || 'æ¸¬è©¦å¤±æ•—'}`, 3000);
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }
    
    async function testProtections() {
      toast('æ­£åœ¨æ¸¬è©¦é˜²è­·ç³»çµ±...', 3000);
      
      const results = [];
      
      // æ¸¬è©¦ Wake Lock
      if ('wakeLock' in navigator) {
        results.push('âœ“ Wake Lock æ”¯æ´');
      } else {
        results.push('âœ— Wake Lock ä¸æ”¯æ´');
      }
      
      // æ¸¬è©¦éŸ³é »
      if (silentAudio) {
        results.push('âœ“ éœéŸ³éŸ³é »å¯ç”¨');
      } else {
        results.push('âœ— éœéŸ³éŸ³é »ä¸å¯ç”¨');
      }
      
      // æ¸¬è©¦ LocalStorage
      try {
        localStorage.setItem('test', 'test');
        localStorage.removeItem('test');
        results.push('âœ“ LocalStorage å¯ç”¨');
      } catch (e) {
        results.push('âœ— LocalStorage ä¸å¯ç”¨');
      }
      
      // æ¸¬è©¦é›»æ±  API
      if ('getBattery' in navigator) {
        results.push('âœ“ é›»æ± ç›£æ§æ”¯æ´');
      } else {
        results.push('âœ— é›»æ± ç›£æ§ä¸æ”¯æ´');
      }
      
      // æ¸¬è©¦é é¢å¯è¦‹æ€§ API
      if ('visibilityState' in document) {
        results.push('âœ“ é é¢å¯è¦‹æ€§ API æ”¯æ´');
      } else {
        results.push('âœ— é é¢å¯è¦‹æ€§ API ä¸æ”¯æ´');
      }
      
      setTimeout(() => {
        alert('é˜²è­·ç³»çµ±æ¸¬è©¦çµæœï¼š\n\n' + results.join('\n'));
      }, 500);
    }
    
    function forceBackup() {
      if (!tripActive) {
        toast('ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„è¡Œç¨‹', 2000);
        return;
      }
      
      if (saveCurrentTrip()) {
        toast('âœ“ å‚™ä»½æˆåŠŸ', 2000);
      } else {
        toast('âœ— å‚™ä»½å¤±æ•—', 2000);
      }
    }

    // ========== æ­·å²è¨˜éŒ„ ==========
    function renderTrips() {
      const list = $('tripList');
      list.innerHTML = '';
      
      $('tripCount').textContent = `å…± ${trips.length} ç­†`;
      
      if (trips.length === 0) {
        list.innerHTML = `
          <div class="text-center py-12 text-neutral-500">
            <span class="material-symbols-outlined text-[48px] opacity-30">folder_open</span>
            <p class="mt-2">å°šç„¡è¡Œç¨‹è¨˜éŒ„</p>
            <p class="text-xs mt-1">é–‹å§‹è¨˜éŒ„å¾Œæœƒé¡¯ç¤ºåœ¨é€™è£¡</p>
          </div>
        `;
      } else {
        trips.forEach((t, i) => {
          const card = document.createElement('div');
          card.className = 'bg-surface-dark rounded-2xl p-4 border border-white/5';
          card.innerHTML = `
            <div class="flex items-start justify-between mb-3">
              <div class="flex-1">
                <h3 class="font-bold text-white text-lg mb-1">${t.title}</h3>
                <p class="text-sm text-neutral-400">${t.start} - ${t.end}</p>
                ${t.reconnects > 0 ? `<p class="text-xs text-yellow-400 mt-1">âš ï¸ GPS é‡é€£ ${t.reconnects} æ¬¡ | å®šä½é»ï¼š${t.points}</p>` : `<p class="text-xs text-primary mt-1">âœ“ ç©©å®šè¨˜éŒ„ | å®šä½é»ï¼š${t.points}</p>`}
              </div>
              <button onclick="deleteTrip(${i})" class="text-red-500 hover:text-red-400 transition-colors">
                <span class="material-symbols-outlined">delete</span>
              </button>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div class="bg-background-dark rounded-lg p-3">
                <p class="text-xs text-neutral-400 mb-1">é‡Œç¨‹</p>
                <p class="text-lg font-bold text-primary">${t.km.toFixed(3)} km</p>
              </div>
              <div class="bg-background-dark rounded-lg p-3">
                <p class="text-xs text-neutral-400 mb-1">ç´¯ç©</p>
                <p class="text-lg font-bold text-white">${t.odoTotal.toFixed(3)} km</p>
              </div>
            </div>
            <div class="mt-3 flex gap-2">
              <button onclick="renameTrip('start',${i})" class="flex-1 text-xs py-2 px-3 bg-white/5 hover:bg-white/10 text-neutral-300 rounded-lg transition-colors">
                æ”¹èµ·é»
              </button>
              <button onclick="renameTrip('end',${i})" class="flex-1 text-xs py-2 px-3 bg-white/5 hover:bg-white/10 text-neutral-300 rounded-lg transition-colors">
                æ”¹çµ‚é»
              </button>
            </div>
          `;
          list.appendChild(card);
        });
      }
    }
    
    function renameTrip(which, idx) {
      const t = trips[idx];
      const label = which === 'start' ? "èµ·é»åç¨±" : "çµ‚é»åç¨±";
      const cur = which === 'start' ? t.startName : t.endName;
      const v = requireNonEmpty(`ä¿®æ”¹${label}`, cur || "");
      if (v === null) return;
      
      if (which === 'start') {
        t.startName = v;
      } else {
        t.endName = v;
      }
      t.title = tripTitle(t.startName, t.endName);
      renderTrips();
      saveTripsToStorage();
      toast('âœ“ å·²æ›´æ–°', 1500);
    }
    
    function deleteTrip(idx) {
      const t = trips[idx];
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤è¡Œç¨‹ã€Œ${t.title}ã€å—ï¼Ÿ`)) return;
      trips.splice(idx, 1);
      renderTrips();
      saveTripsToStorage();
      toast('âœ“ å·²åˆªé™¤', 1500);
    }
    
    // ========== è·¯ç·šé¡¯ç¤º ==========
    let routeMapInstance = null;
    let routePolyline = null;
    
    function showRoute(idx) {
      const trip = trips[idx];
      if (!trip.route || trip.route.length === 0) {
        toast('æ­¤è¡Œç¨‹ç„¡è·¯ç·šè³‡æ–™', 2000);
        return;
      }
      
      // é¡¯ç¤ºå½ˆçª—
      $('routeModal').classList.remove('hidden');
      
      // è¨­å®šæ¨™é¡Œå’Œè³‡è¨Š
      $('routeModalTitle').textContent = trip.title;
      $('routeModalSubtitle').textContent = `${trip.start} - ${trip.end}`;
      $('routeStartName').textContent = trip.startName;
      $('routeEndName').textContent = trip.endName;
      $('routeDistance').textContent = `${trip.km.toFixed(3)} km`;
      $('routePoints').textContent = `${trip.points || trip.route.length} é»`;
      
      // åˆå§‹åŒ–åœ°åœ–
      setTimeout(() => {
        initRouteMap(trip.route);
      }, 100);
    }
    
    function initRouteMap(routePoints) {
      // æ¸…é™¤èˆŠåœ°åœ–
      if (routeMapInstance) {
        routeMapInstance.remove();
        routeMapInstance = null;
      }
      
      // è¨ˆç®—ä¸­å¿ƒé»
      const lats = routePoints.map(p => p[0]);
      const lngs = routePoints.map(p => p[1]);
      const centerLat = (Math.min(...lats) + Math.max(...lats)) / 2;
      const centerLng = (Math.min(...lngs) + Math.max(...lngs)) / 2;
      
      // å‰µå»ºåœ°åœ–
      routeMapInstance = L.map('routeMap', {
        center: [centerLat, centerLng],
        zoom: 13,
        zoomControl: true
      });
      
      // æ·»åŠ åœ–å±¤
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap',
        maxZoom: 19
      }).addTo(routeMapInstance);
      
      // ç•«è·¯ç·š
      routePolyline = L.polyline(routePoints, {
        color: '#13ec5b',
        weight: 4,
        opacity: 0.8,
        smoothFactor: 1
      }).addTo(routeMapInstance);
      
      // æ¨™è¨˜èµ·é»å’Œçµ‚é»
      if (routePoints.length > 0) {
        const startPoint = routePoints[0];
        const endPoint = routePoints[routePoints.length - 1];
        
        // èµ·é»æ¨™è¨˜ï¼ˆç¶ è‰²ï¼‰
        L.marker(startPoint, {
          icon: L.divIcon({
            className: 'custom-marker',
            html: `<div style="background: #13ec5b; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-center; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"><span style="color: #102216; font-size: 20px;">â–¶</span></div>`,
            iconSize: [32, 32],
            iconAnchor: [16, 16]
          })
        }).addTo(routeMapInstance);
        
        // çµ‚é»æ¨™è¨˜ï¼ˆç´…è‰²ï¼‰
        L.marker(endPoint, {
          icon: L.divIcon({
            className: 'custom-marker',
            html: `<div style="background: #ef4444; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-center; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"><span style="color: white; font-size: 20px;">â¬›</span></div>`,
            iconSize: [32, 32],
            iconAnchor: [16, 16]
          })
        }).addTo(routeMapInstance);
      }
      
      // è‡ªå‹•èª¿æ•´è¦–é‡ä»¥é¡¯ç¤ºå®Œæ•´è·¯ç·š
      routeMapInstance.fitBounds(routePolyline.getBounds(), {
        padding: [50, 50]
      });
    }
    
    function closeRouteModal() {
      $('routeModal').classList.add('hidden');
      if (routeMapInstance) {
        routeMapInstance.remove();
        routeMapInstance = null;
      }
    }

    // ========== Excel åŒ¯å‡º ==========
    function exportXLSX() {
      if (trips.length === 0) {
        toast('æ²’æœ‰è¡Œç¨‹å¯åŒ¯å‡º', 2000);
        return;
      }
      
      const driver = $('driver').value || '';
      const plate = $('plate').value || '';
      const person = $('personName').value || '';
      const startOdoStr = ($('startOdo').value || '').trim();
      const baseStartOdo = startOdoStr === '' ? 0 : parseFloat(startOdoStr);
      
      const headers = [
        'è¡Œç¨‹åç¨±', 'å•Ÿç¨‹åœ°é»', 'åœæ­¢åœ°é»', 'èµ·ç¨‹æ™‚é–“', 'åˆ°é”æ™‚é–“',
        'å•Ÿç¨‹å…¬é‡Œæ•¸', 'åˆ°é”å…¬é‡Œæ•¸', 'å°è¨ˆé‡Œç¨‹æ•¸', 'é§•é§›äºº', 'è»Šç‰Œ', 'ç”³è«‹äºº', 'å®šä½é»æ•¸', 'GPSé‡é€£æ¬¡æ•¸'
      ];
      
      let accumulatedKm = isNaN(baseStartOdo) ? 0 : baseStartOdo;
      
      const rows = trips.map(t => {
        const tripKm = Number(t.km || 0);
        const startKm = accumulatedKm;
        const endKm = startKm + tripKm;
        accumulatedKm = endKm;
        
        return [
          t.title || '', t.startName || '', t.endName || '',
          t.start || '', t.end || '',
          Number(startKm.toFixed(3)), Number(endKm.toFixed(3)), Number(tripKm.toFixed(3)),
          driver, plate, person, t.points || 0, t.reconnects || 0
        ];
      });
      
      const data = [headers, ...rows];
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(data);
      
      ws['!freeze'] = { xSplit: 0, ySplit: 1, topLeftCell: 'A2', activePane: 'bottomLeft', state: 'frozen' };
      ws['!cols'] = [
        { wch: 20 }, { wch: 16 }, { wch: 16 }, { wch: 18 }, { wch: 18 },
        { wch: 14 }, { wch: 14 }, { wch: 14 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 10 }, { wch: 12 }
      ];
      
      XLSX.utils.book_append_sheet(wb, ws, 'è¡Œç¨‹è¨˜éŒ„');
      
      const filename = `GPSè¡Œç¨‹è¨˜éŒ„_çµ‚æ¥µç‰ˆ_${new Date().toISOString().split('T')[0]}.xlsx`;
      XLSX.writeFile(wb, filename);
      toast('âœ“ Excel å·²åŒ¯å‡º', 2000);
    }

    // ========== è³‡æ–™æŒä¹…åŒ– ==========
    const STORAGE_KEYS = {
      plate: 'gps_plate',
      driver: 'gps_driver',
      personName: 'gps_personName',
      startOdo: 'gps_startOdo',
      trips: 'gps_trips_v5_ultimate',
      ultimateMode: 'gps_ultimate_mode'
    };
    
    function saveMeta() {
      try {
        localStorage.setItem(STORAGE_KEYS.plate, $('plate').value || '');
        localStorage.setItem(STORAGE_KEYS.driver, $('driver').value || '');
        localStorage.setItem(STORAGE_KEYS.personName, $('personName').value || '');
        localStorage.setItem(STORAGE_KEYS.startOdo, $('startOdo').value || '');
        localStorage.setItem('distCoef', $('distCoef').value || '1.10');
        localStorage.setItem('enablePreciseCalc', $('enablePreciseCalc').checked ? 'true' : 'false');
        renderCurrentOdo();
      } catch (e) {
        console.error('å„²å­˜å¤±æ•—ï¼š', e);
      }
    }
    
    function loadMeta() {
      try {
        $('plate').value = localStorage.getItem(STORAGE_KEYS.plate) || '';
        $('driver').value = localStorage.getItem(STORAGE_KEYS.driver) || '';
        $('personName').value = localStorage.getItem(STORAGE_KEYS.personName) || '';
        $('startOdo').value = localStorage.getItem(STORAGE_KEYS.startOdo) || '';
        $('distCoef').value = localStorage.getItem('distCoef') || '1.10';
        $('enablePreciseCalc').checked = localStorage.getItem('enablePreciseCalc') === 'true';
        
        const savedMode = localStorage.getItem(STORAGE_KEYS.ultimateMode);
        if (savedMode !== null) {
          ultimateMode = savedMode === 'true';
          $('ultimateMode').checked = ultimateMode;
        }
        
        renderCurrentOdo();
      } catch (e) {
        console.error('è®€å–å¤±æ•—ï¼š', e);
      }
    }
    
    function saveTripsToStorage() {
      try {
        localStorage.setItem(STORAGE_KEYS.trips, JSON.stringify(trips));
        localStorage.setItem(STORAGE_KEYS.ultimateMode, ultimateMode.toString());
      } catch (e) {
        console.error('å„²å­˜è¡Œç¨‹å¤±æ•—ï¼š', e);
      }
    }
    
    function loadTripsFromStorage() {
      try {
        const saved = localStorage.getItem(STORAGE_KEYS.trips);
        if (saved) {
          trips = JSON.parse(saved);
        }
      } catch (e) {
        console.error('è®€å–è¡Œç¨‹å¤±æ•—ï¼š', e);
      }
    }
    
    async function resetAll() {
      if (!confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è¨˜éŒ„å—ï¼Ÿ\n\næ­¤æ“ä½œå°‡åˆªé™¤æ‰€æœ‰è¡Œç¨‹è¨˜éŒ„\nåŸºæœ¬è³‡æ–™ä¸æœƒè¢«æ¸…é™¤\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
        return;
      }
      
      trips = [];
      renderTrips();
      
      tripActive = false;
      tripDist = 0;
      tripStartTime = null;
      tripStartName = "";
      tripEndName = "";
      totalPoints = 0;
      reconnectCount = 0;
      wakeupCount = 0;
      autoSaveCount = 0;
      
      $('tripDist').textContent = '0.000';
      smartScaleNumber('tripDist');
      $('tripName').textContent = 'ç­‰å¾…é–‹å§‹';
      renderCurrentOdo();
      last = null;
      
      if (track) track.setLatLngs([]);
      
      await stopAllProtections();
      clearCurrentTripBackup();
      
      saveTripsToStorage();
      updateMainButton('start');
      updateStats();
      
      toast('âœ“ æ‰€æœ‰è¨˜éŒ„å·²æ¸…é™¤', 2000);
    }

    // ========== åœ°åœ–åˆå§‹åŒ– ==========
    function initMap() {
      try {
        map = L.map('map', {
          zoomControl: false,
          attributionControl: false,
          dragging: false,
          touchZoom: false,
          doubleClickZoom: false,
          scrollWheelZoom: false,
          boxZoom: false,
          keyboard: false,
        });
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19
        }).addTo(map);
        
        map.setView([25.0330, 121.5654], 13);
        
        marker = L.marker([25.0330, 121.5654], {
          icon: L.divIcon({
            className: 'custom-marker',
            html: '<div style="background:#13ec5b;width:20px;height:20px;border-radius:50%;border:4px solid white;box-shadow:0 0 12px rgba(19,236,91,0.6)"></div>',
            iconSize: [28, 28],
            iconAnchor: [14, 14]
          })
        }).addTo(map);
        
        circle = L.circle([25.0330, 121.5654], {
          color: '#13ec5b',
          fillColor: '#13ec5b',
          fillOpacity: 0.1,
          radius: 50
        }).addTo(map);
        
        track = L.polyline([], {
          color: '#13ec5b',
          weight: 5,
          opacity: 0.9,
          smoothFactor: 1.5,
          lineJoin: 'round',
          lineCap: 'round'
        }).addTo(map);
        
      } catch (e) {
        console.error('åœ°åœ–åˆå§‹åŒ–å¤±æ•—ï¼š', e);
        toast('åœ°åœ–åˆå§‹åŒ–å¤±æ•—', 3000);
      }
    }

    // ========== åˆå§‹åŒ– ==========
    window.addEventListener('load', async () => {
      initMap();
      loadMeta();
      loadTripsFromStorage();
      updateMainButton('start');
      updateStats();
      
      // åˆå§‹åŒ–æ•¸å­—ç¸®æ”¾
      smartScaleNumber('tripDist');
      smartScaleNumber('currentOdo');
      
      ['plate', 'driver', 'personName', 'startOdo'].forEach(id =>
        $(id).addEventListener('input', saveMeta)
      );
      
      // æª¢æŸ¥å‚™ä»½
      const backup = loadCurrentTripBackup();
      if (backup && !tripActive) {
        toast('âš ï¸ åµæ¸¬åˆ°æœªå®Œæˆçš„è¡Œç¨‹å‚™ä»½', 3000);
      }
      
      console.log('ğŸš— GPSæ²¹å–®è¼”åŠ©ç³»çµ± v1.0.0 å·²å°±ç·’');
      console.log('ğŸ›¡ï¸ é˜²è­·ç³»çµ±ï¼šWake Lock + éŸ³é »ä¿æ´» + è‡ªå‹•å‚™ä»½ + GPS ç›£æ§');
    });
    
    window.addEventListener('beforeunload', (e) => {
      if (tripActive) {
        saveCurrentTrip(); // æœ€å¾Œå‚™ä»½
        e.preventDefault();
        e.returnValue = 'æ‚¨æœ‰é€²è¡Œä¸­çš„è¡Œç¨‹å°šæœªçµæŸï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ';
      }
    });
  </script>

  <!-- è·¯ç·šé¡¯ç¤ºå½ˆçª— -->
  <div id="routeModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
    <div class="bg-surface-dark rounded-3xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden border border-white/10 shadow-2xl">
      <!-- æ¨™é¡Œåˆ— -->
      <div class="flex items-center justify-between p-6 border-b border-white/10">
        <div class="flex-1">
          <h3 id="routeModalTitle" class="text-xl font-bold text-white">è¡Œç¨‹è·¯ç·š</h3>
          <p id="routeModalSubtitle" class="text-sm text-neutral-400 mt-1"></p>
        </div>
        <button onclick="closeRouteModal()" class="text-neutral-400 hover:text-white transition-colors">
          <span class="material-symbols-outlined text-[28px]">close</span>
        </button>
      </div>
      
      <!-- åœ°åœ–å€åŸŸ -->
      <div class="flex-1 relative overflow-hidden">
        <div id="routeMap" class="w-full h-full min-h-[400px]"></div>
      </div>
      
      <!-- è³‡è¨Šåˆ— -->
      <div id="routeInfo" class="p-6 border-t border-white/10 bg-background-dark/50">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div>
            <p class="text-xs text-neutral-400 mb-1">èµ·é»</p>
            <p id="routeStartName" class="text-sm font-semibold text-white"></p>
          </div>
          <div>
            <p class="text-xs text-neutral-400 mb-1">çµ‚é»</p>
            <p id="routeEndName" class="text-sm font-semibold text-white"></p>
          </div>
          <div>
            <p class="text-xs text-neutral-400 mb-1">é‡Œç¨‹</p>
            <p id="routeDistance" class="text-sm font-semibold text-primary"></p>
          </div>
          <div>
            <p class="text-xs text-neutral-400 mb-1">å®šä½é»</p>
            <p id="routePoints" class="text-sm font-semibold text-white"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
